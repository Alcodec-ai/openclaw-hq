<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw HQ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
  --bg: #f5f5f7;
  --bg-white: #ffffff;
  --bg-panel: rgba(255,255,255,0.72);
  --bg-hover: rgba(0,0,0,0.03);
  --bg-active: rgba(0,122,255,0.06);
  --border: rgba(0,0,0,0.06);
  --border-strong: rgba(0,0,0,0.1);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.03);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
  --shadow-xl: 0 20px 60px rgba(0,0,0,0.1), 0 8px 20px rgba(0,0,0,0.06);
  --text: #1d1d1f;
  --text-secondary: #6e6e73;
  --text-tertiary: #aeaeb2;
  --blue: #007aff;
  --green: #34c759;
  --orange: #ff9500;
  --red: #ff3b30;
  --purple: #af52de;
  --teal: #5ac8fa;
  --pink: #ff2d55;
  --indigo: #5856d6;
  --topbar-h: 52px;
  --sidebar-w: 260px;
  --radius: 14px;
  --radius-sm: 10px;
  --radius-xs: 8px;
}

[data-theme="dark"] {
  --bg: #1c1c1e;
  --bg-white: #2c2c2e;
  --bg-panel: rgba(44,44,46,0.72);
  --bg-hover: rgba(255,255,255,0.05);
  --bg-active: rgba(10,132,255,0.12);
  --border: rgba(255,255,255,0.06);
  --border-strong: rgba(255,255,255,0.1);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.15);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.2);
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.25);
  --shadow-xl: 0 20px 60px rgba(0,0,0,0.5), 0 8px 20px rgba(0,0,0,0.3);
  --text: #f5f5f7;
  --text-secondary: #a1a1a6;
  --text-tertiary: #636366;
  --blue: #0a84ff;
  --green: #30d158;
  --orange: #ff9f0a;
  --red: #ff453a;
  --purple: #bf5af2;
  --teal: #64d2ff;
  --pink: #ff375f;
  --indigo: #5e5ce6;
}

/* Theme transition */
html.theme-transition,
html.theme-transition *,
html.theme-transition *::before,
html.theme-transition *::after {
  transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, color 0.15s ease !important;
}
html.theme-transition canvas { transition: none !important; }

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

/* ── TOPBAR ── */
#topbar {
  position: fixed; top: 0; left: 0; right: 0; height: var(--topbar-h);
  background: var(--bg-panel);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  border-bottom: 0.5px solid var(--border-strong);
  display: flex; align-items: center; padding: 0 20px; gap: 16px; z-index: 200;
}

.logo-section { display: flex; align-items: center; gap: 10px; padding-right: 16px; }
.logo-icon {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #f0932b 100%);
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 2px 8px rgba(238,90,36,0.25);
}
.logo-text { font-size: 15px; font-weight: 700; color: var(--text); letter-spacing: -0.3px; }
.logo-sub { font-size: 10px; color: var(--text-tertiary); font-weight: 500; letter-spacing: 0.5px; }

#gw-badge {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 12px; border-radius: 20px;
  background: rgba(52,199,89,0.08); font-size: 11px; color: var(--text-secondary);
}
#gw-badge.offline-badge { background: rgba(0,0,0,0.04); }
#gw-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text-tertiary); transition: all 0.4s; }
#gw-dot.on { background: var(--green); box-shadow: 0 0 6px rgba(52,199,89,0.4); }

.topbar-kpis { display: flex; gap: 6px; margin-left: 4px; }
.kpi-pill {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 10px; border-radius: 16px;
  background: rgba(0,0,0,0.03); font-size: 11px; color: var(--text-secondary);
}
.kpi-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.kpi-dot.blue { background: var(--blue); }
.kpi-dot.green { background: var(--green); }
.kpi-val { font-weight: 700; color: var(--text); font-size: 12px; }

.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
#topbar-meta { font-size: 10px; color: var(--text-tertiary); font-family: 'SF Mono', 'Menlo', monospace; }
#live-clock {
  font-size: 12px; font-weight: 600; color: var(--text-secondary);
  font-family: 'SF Mono', 'Menlo', monospace;
  padding: 4px 10px; border-radius: var(--radius-xs);
  background: rgba(0,0,0,0.03);
}
#btn-drawer {
  display: flex; align-items: center; gap: 5px;
  background: rgba(0,0,0,0.04); border: none; color: var(--text-secondary);
  padding: 6px 12px; border-radius: var(--radius-xs);
  cursor: pointer; font-size: 11px; font-family: inherit; font-weight: 500;
  transition: all 0.2s;
}
#btn-drawer:hover { background: rgba(0,0,0,0.07); color: var(--text); }

/* ── SIDEBAR ── */
#sidebar {
  position: fixed; top: var(--topbar-h); left: 0; width: var(--sidebar-w); bottom: 0;
  background: var(--bg-panel);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  border-right: 0.5px solid var(--border-strong);
  display: flex; flex-direction: column; z-index: 100;
}

#sidebar-hdr {
  padding: 16px 16px 10px; display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.shdr-label { font-size: 13px; font-weight: 700; color: var(--text); }
.shdr-count {
  font-size: 11px; font-weight: 600; color: var(--blue);
  background: rgba(0,122,255,0.08); padding: 2px 8px; border-radius: 10px;
}

#sidebar-stats {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 4px; padding: 0 12px 12px; flex-shrink: 0;
}
.ss-item {
  text-align: center; padding: 8px 2px;
  border-radius: var(--radius-xs); background: rgba(0,0,0,0.02);
}
.ss-num { font-size: 18px; font-weight: 800; display: block; }
.ss-num.busy { color: var(--blue); }
.ss-num.idle { color: var(--green); }
.ss-num.inactive { color: var(--orange); }
.ss-num.offline { color: var(--text-tertiary); }
.ss-lbl { font-size: 9px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1px; display: block; font-weight: 500; }

#agent-list {
  flex: 1; overflow-y: auto; padding: 4px 8px;
  border-top: 0.5px solid var(--border);
}

.agent-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 10px; cursor: pointer;
  border-radius: var(--radius-sm); margin-bottom: 1px;
  transition: all 0.15s ease;
}
.agent-item:hover { background: var(--bg-hover); }
.agent-item.sel { background: var(--bg-active); }

.agent-avatar {
  width: 36px; height: 36px; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: white;
  flex-shrink: 0; position: relative;
  text-transform: uppercase; letter-spacing: 0.3px;
  box-shadow: var(--shadow-sm);
}
.agent-avatar .av-status {
  position: absolute; bottom: -1px; right: -1px;
  width: 11px; height: 11px; border-radius: 50%;
  border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.av-status.busy     { background: var(--blue); animation: pulse-dot 2s infinite; }
.av-status.idle     { background: var(--green); }
.av-status.inactive { background: var(--orange); }
.av-status.offline  { background: #c7c7cc; }
@keyframes pulse-dot { 0%,100%{transform:scale(1)} 50%{transform:scale(0.8)} }

.agent-info { flex: 1; min-width: 0; }
.ai-name { font-size: 13px; font-weight: 600; color: var(--text); }
.ai-task {
  font-size: 11px; color: var(--text-tertiary); margin-top: 1px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 145px;
}
.ai-meta { display: flex; align-items: center; gap: 4px; margin-top: 3px; }
.ai-sessions {
  font-size: 9px; color: var(--text-tertiary); background: rgba(0,0,0,0.04);
  padding: 1px 6px; border-radius: 6px; font-weight: 500;
}

/* ── MAIN AREA ── */
#main-area {
  position: fixed; top: var(--topbar-h); left: var(--sidebar-w); right: 0; bottom: 0;
  overflow: hidden; display: flex; flex-direction: column; background: var(--bg);
}

#float-stats {
  display: flex; gap: 8px; padding: 12px 14px;
  flex-shrink: 0; background: var(--bg);
}
.fstat {
  flex: 1; background: var(--bg-white); border-radius: var(--radius);
  padding: 14px 16px; box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.25,0.1,0.25,1); border: 0.5px solid var(--border);
  position: relative; overflow: hidden;
}
.fstat::after {
  content: ''; position: absolute; inset: 0; border-radius: var(--radius);
  background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.15) 50%, transparent 60%);
  background-size: 300% 300%; animation: shimmer 3s ease-in-out infinite;
  pointer-events: none; opacity: 0; transition: opacity 0.3s;
}
.fstat:hover::after { opacity: 1; }
.fstat:hover { box-shadow: var(--shadow-md); transform: translateY(-2px) scale(1.01); }
@keyframes shimmer { 0%{background-position:100% 100%} 50%{background-position:0 0} 100%{background-position:100% 100%} }
.fstat-label { font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600; }
.fstat-row { display: flex; align-items: baseline; gap: 6px; margin-top: 4px; }
.fstat-value {
  font-size: 22px; font-weight: 800; color: var(--text); letter-spacing: -0.5px;
  transition: transform 0.3s, color 0.3s;
}
.fstat-value.counting { transform: scale(1.15); color: var(--blue); }
.fstat-unit { font-size: 11px; color: var(--text-tertiary); }
.fstat-bar { height: 4px; background: rgba(0,0,0,0.04); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.fstat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.8s cubic-bezier(0.25,0.1,0.25,1); }
.fstat.pulse { animation: statPulse 0.6s ease; }
@keyframes statPulse {
  0%{box-shadow:var(--shadow-sm)} 50%{box-shadow:0 0 20px rgba(0,122,255,0.2)} 100%{box-shadow:var(--shadow-sm)}
}

#canvas-wrap { flex: 1; position: relative; overflow: hidden; border-radius: var(--radius) var(--radius) 0 0; margin: 0 14px; }
#office { position: absolute; inset: 0; display: block; z-index: 2; cursor: pointer; }

/* ── OVERLAY ── */
#overlay {
  display: none; position: fixed; inset: 0; z-index: 140;
  background: rgba(0,0,0,0.15);
  backdrop-filter: blur(2px);
}
#overlay.show { display: block; }

/* ── DETAIL PANEL ── */
#detail-panel {
  position: fixed; top: var(--topbar-h); right: 0; width: 380px; bottom: 0;
  background: var(--bg-panel);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  border-left: 0.5px solid var(--border-strong);
  transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.25,0.1,0.25,1);
  display: flex; flex-direction: column; z-index: 150; overflow: hidden;
  box-shadow: -8px 0 30px rgba(0,0,0,0.06);
}
#detail-panel.open { transform: translateX(0); }

#dp-hdr {
  padding: 20px; display: flex; align-items: center; gap: 14px; flex-shrink: 0;
  border-bottom: 0.5px solid var(--border);
}
#dp-avatar-lg {
  width: 48px; height: 48px; border-radius: var(--radius);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 800; color: white;
  letter-spacing: 0.5px; box-shadow: var(--shadow-md);
}
#dp-info { flex: 1; }
#dp-name { font-size: 17px; font-weight: 700; color: var(--text); letter-spacing: -0.2px; }
#dp-model { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
#dp-status-badge {
  font-size: 10px; font-weight: 600; padding: 3px 10px;
  border-radius: 12px; text-transform: capitalize;
}
#btn-dp-close {
  background: rgba(0,0,0,0.04); border: none; color: var(--text-tertiary);
  cursor: pointer; font-size: 16px; width: 32px; height: 32px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; flex-shrink: 0;
}
#btn-dp-close:hover { background: rgba(255,59,48,0.08); color: var(--red); }

#dp-tabs { display: flex; flex-shrink: 0; padding: 0 16px; gap: 4px; border-bottom: 0.5px solid var(--border); }
.dtab {
  padding: 10px 14px; text-align: center; font-size: 12px;
  color: var(--text-tertiary); cursor: pointer;
  border-bottom: 2px solid transparent; transition: all 0.15s; font-weight: 500;
  border-radius: var(--radius-xs) var(--radius-xs) 0 0;
}
.dtab:hover { color: var(--text-secondary); background: var(--bg-hover); }
.dtab.act { color: var(--blue); border-bottom-color: var(--blue); font-weight: 600; }

#dp-body { flex: 1; overflow-y: auto; padding: 16px 20px; }

#task-form {
  border-top: 0.5px solid var(--border); padding: 16px 20px; flex-shrink: 0;
  background: rgba(0,0,0,0.01);
}
#task-form label { font-size: 11px; color: var(--text-tertiary); display: block; margin-bottom: 8px; font-weight: 500; }
#task-input {
  width: 100%; background: var(--bg-white); border: 0.5px solid var(--border-strong); color: var(--text);
  padding: 10px 14px; border-radius: var(--radius-xs); font-size: 13px; font-family: inherit;
  resize: vertical; min-height: 72px; outline: none; transition: all 0.2s;
}
#task-input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }
#btn-send {
  width: 100%; margin-top: 10px; padding: 10px;
  background: var(--blue); border: none; color: white;
  border-radius: var(--radius-xs); cursor: pointer;
  font-size: 13px; font-family: inherit; font-weight: 600; transition: all 0.15s;
}
#btn-send:hover { background: #0066d6; }
#btn-send:active { transform: scale(0.98); }
#btn-send:disabled { background: #c7c7cc; cursor: not-allowed; }
#task-ok  { margin-top: 8px; font-size: 11px; color: var(--green); display: none; padding: 10px; background: rgba(52,199,89,0.06); border-radius: var(--radius-xs); }
#task-err { margin-top: 8px; font-size: 11px; color: var(--red); display: none; padding: 10px; background: rgba(255,59,48,0.06); border-radius: var(--radius-xs); }

/* token bar */
.tbar-wrap { margin-bottom: 14px; }
.tbar-lbl { font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; display: flex; justify-content: space-between; }
.tbar { height: 6px; background: rgba(0,0,0,0.04); border-radius: 3px; overflow: hidden; }
.tbar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.tbar-fill.low { background: linear-gradient(90deg, #34c759, #30d158); }
.tbar-fill.mid { background: linear-gradient(90deg, #ff9500, #ffb340); }
.tbar-fill.high { background: linear-gradient(90deg, #ff3b30, #ff6961); }

/* message bubbles */
.mb {
  padding: 10px 14px; border-radius: var(--radius-sm); margin-bottom: 8px;
  font-size: 12px; line-height: 1.6; word-break: break-word;
}
.mb.user { background: rgba(0,122,255,0.06); color: #1a3a5c; border-left: 3px solid var(--blue); }
.mb.assistant { background: rgba(52,199,89,0.06); color: #1a3c1a; border-left: 3px solid var(--green); }
.mb-time { font-size: 9px; color: var(--text-tertiary); margin-top: 4px; }

.sec { font-size: 11px; color: var(--text-tertiary); letter-spacing: 0.5px; text-transform: uppercase; margin: 16px 0 8px; font-weight: 600; }
.info-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; padding: 3px 0; }
.info-row .v { color: var(--text); font-weight: 500; }

.stat-card {
  background: rgba(0,0,0,0.02); border-radius: var(--radius-sm);
  padding: 14px 16px;
}
.stat-card .sc-label { font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.stat-card .sc-value { font-size: 22px; font-weight: 800; color: var(--text); margin-top: 4px; letter-spacing: -0.5px; }

/* ── INFO DRAWER ── */
#info-drawer {
  position: fixed; top: var(--topbar-h); right: 0; width: 400px; bottom: 0;
  background: var(--bg-panel);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  border-left: 0.5px solid var(--border-strong);
  transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.25,0.1,0.25,1);
  display: flex; flex-direction: column; z-index: 130;
  box-shadow: -8px 0 30px rgba(0,0,0,0.06);
}
#info-drawer.open { transform: translateX(0); }
#idr-hdr {
  padding: 16px 20px; display: flex; align-items: center; gap: 10px;
  border-bottom: 0.5px solid var(--border);
}
#idr-hdr span { font-size: 15px; font-weight: 700; flex: 1; color: var(--text); }
#btn-idr-close {
  background: rgba(0,0,0,0.04); border: none; color: var(--text-tertiary);
  cursor: pointer; font-size: 14px; width: 28px; height: 28px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
#btn-idr-close:hover { background: rgba(255,59,48,0.08); color: var(--red); }
#idr-body { flex: 1; overflow-y: auto; padding: 16px 20px; }

.drawer-section {
  background: var(--bg-white); border-radius: var(--radius);
  padding: 14px 16px; margin-bottom: 10px;
  box-shadow: var(--shadow-sm); border: 0.5px solid var(--border);
}
.drawer-section .ds-title {
  font-size: 10px; color: var(--text-tertiary); letter-spacing: 1px;
  text-transform: uppercase; font-weight: 700; margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.ds-title .ds-icon { font-size: 12px; }

.ch-row {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 0; border-bottom: 0.5px solid var(--border); font-size: 12px;
}
.ch-row:last-child { border-bottom: none; }
.ch-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.ch-dot.running { background: var(--green); box-shadow: 0 0 4px rgba(52,199,89,0.3); }
.ch-dot.stopped { background: var(--orange); }
.ch-dot.off { background: #c7c7cc; }
.ch-name { flex: 1; color: var(--text); font-weight: 500; }
.ch-detail { font-size: 10px; color: var(--text-tertiary); }

.log-line {
  font-size: 10px; padding: 3px 0; border-bottom: 0.5px solid var(--border);
  display: flex; gap: 6px; align-items: flex-start;
  font-family: 'SF Mono', 'Menlo', monospace;
}
.log-t { color: var(--text-tertiary); flex-shrink: 0; }
.log-l { padding: 1px 5px; border-radius: 4px; font-size: 9px; flex-shrink: 0; font-weight: 600; }
.log-l.INFO  { background: rgba(0,122,255,0.08); color: var(--blue); }
.log-l.WARN  { background: rgba(255,149,0,0.08); color: var(--orange); }
.log-l.ERROR { background: rgba(255,59,48,0.08); color: var(--red); }
.log-l.DEBUG { background: rgba(0,0,0,0.04); color: var(--text-tertiary); }
.log-m { color: var(--text-secondary); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
#log-wrap { max-height: 280px; overflow-y: auto; }

/* Model selector */
.model-select {
  width: 100%; padding: 8px 12px; border-radius: var(--radius-xs);
  background: var(--bg-white); border: 0.5px solid var(--border-strong);
  color: var(--text); font-size: 12px; font-family: inherit;
  outline: none; cursor: pointer; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%236e6e73' stroke-width='1.5'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
  transition: all 0.2s;
}
.model-select:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }
.model-status { font-size: 10px; margin-top: 4px; min-height: 14px; }

.platform-badge { font-size:9px; font-weight:600; padding:1px 6px; border-radius:6px; }
.platform-badge.telegram { background:rgba(0,136,204,0.08); color:#0088cc; }
.platform-badge.discord { background:rgba(88,101,242,0.08); color:#5865f2; }
.platform-badge.whatsapp { background:rgba(37,211,102,0.08); color:#25d366; }
.platform-badge.none { background:rgba(0,0,0,0.04); color:var(--text-tertiary); }

/* ── SETTINGS PANEL ── */
.settings-group {
  background: var(--bg-white); border-radius: var(--radius);
  padding: 16px 18px; margin-bottom: 12px;
  box-shadow: var(--shadow-sm); border: 0.5px solid var(--border);
}
.settings-group .sg-title {
  font-size: 11px; color: var(--text-tertiary); letter-spacing: 0.8px;
  text-transform: uppercase; font-weight: 700; margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.sg-title .sg-icon { font-size: 14px; }

.setting-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 0; border-bottom: 0.5px solid var(--border);
  font-size: 13px;
}
.setting-row:last-child { border-bottom: none; }
.setting-label { color: var(--text); font-weight: 500; flex: 1; }
.setting-sublabel { font-size: 10px; color: var(--text-tertiary); margin-top: 2px; }

.setting-select {
  padding: 6px 28px 6px 10px; border-radius: var(--radius-xs);
  background: var(--bg); border: 0.5px solid var(--border-strong);
  color: var(--text); font-size: 12px; font-family: inherit;
  outline: none; cursor: pointer; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%236e6e73' stroke-width='1.5'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 8px center;
  transition: all 0.2s; min-width: 140px;
}
.setting-select:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }

.setting-input {
  padding: 6px 10px; border-radius: var(--radius-xs);
  background: var(--bg); border: 0.5px solid var(--border-strong);
  color: var(--text); font-size: 12px; font-family: inherit;
  outline: none; transition: all 0.2s; width: 200px;
}
.setting-input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }

/* Toggle switch */
.toggle-switch {
  position: relative; width: 42px; height: 24px; flex-shrink: 0; cursor: pointer;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-track {
  position: absolute; inset: 0; background: #e5e5ea; border-radius: 12px;
  transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
}
.toggle-switch input:checked + .toggle-track { background: var(--green); }
.toggle-knob {
  position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
  background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
}
.toggle-switch input:checked ~ .toggle-knob { left: 20px; }

/* Buttons */
.btn-action {
  padding: 7px 14px; border-radius: var(--radius-xs); border: none;
  font-size: 12px; font-family: inherit; font-weight: 600;
  cursor: pointer; transition: all 0.15s; display: inline-flex;
  align-items: center; gap: 6px;
}
.btn-action:active { transform: scale(0.97); }
.btn-action.primary { background: var(--blue); color: white; }
.btn-action.primary:hover { background: #0066d6; }
.btn-action.success { background: var(--green); color: white; }
.btn-action.success:hover { background: #2db950; }
.btn-action.danger { background: var(--red); color: white; }
.btn-action.danger:hover { background: #e6352b; }
.btn-action.secondary { background: rgba(0,0,0,0.05); color: var(--text-secondary); }
.btn-action.secondary:hover { background: rgba(0,0,0,0.08); }
.btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-group { display: flex; gap: 6px; }

/* Fallback list */
.fallback-list { margin-top: 8px; }
.fallback-item {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; margin-bottom: 4px;
  background: var(--bg); border-radius: var(--radius-xs);
  font-size: 12px; border: 0.5px solid var(--border);
}
.fallback-item .fb-order {
  font-size: 10px; font-weight: 700; color: var(--text-tertiary);
  min-width: 18px; text-align: center;
}
.fallback-item .fb-name { flex: 1; color: var(--text); font-weight: 500; }
.fallback-item .fb-remove {
  background: none; border: none; color: var(--text-tertiary); cursor: pointer;
  font-size: 14px; padding: 2px 4px; border-radius: 4px; transition: all 0.15s;
}
.fallback-item .fb-remove:hover { color: var(--red); background: rgba(255,59,48,0.08); }
.fallback-item .fb-move {
  background: none; border: none; color: var(--text-tertiary); cursor: pointer;
  font-size: 11px; padding: 2px 4px; border-radius: 4px; transition: all 0.15s;
}
.fallback-item .fb-move:hover { color: var(--blue); background: rgba(0,122,255,0.08); }

/* Channel card */
.channel-card {
  background: var(--bg); border-radius: var(--radius-sm);
  padding: 12px 14px; margin-bottom: 8px; border: 0.5px solid var(--border);
}
.channel-card .cc-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
.channel-card .cc-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.cc-dot.enabled { background: var(--green); box-shadow: 0 0 4px rgba(52,199,89,0.3); }
.cc-dot.disabled { background: #c7c7cc; }
.channel-card .cc-name { font-weight: 600; font-size: 13px; color: var(--text); flex: 1; }
.channel-card .cc-bot { font-size: 10px; color: var(--text-tertiary); }
.channel-card .cc-policies {
  display: grid; grid-template-columns: 1fr 1fr; gap: 6px;
}
.cc-policy-row {
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--text-secondary);
}
.cc-policy-row .cc-p-label { flex-shrink: 0; min-width: 45px; }
.cc-policy-select {
  flex: 1; padding: 4px 22px 4px 8px; border-radius: 6px;
  background: var(--bg-white); border: 0.5px solid var(--border);
  color: var(--text); font-size: 11px; font-family: inherit;
  outline: none; cursor: pointer; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%236e6e73' stroke-width='1.5'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 6px center;
}

/* Toast notification */
.toast {
  position: fixed; bottom: 24px; right: 24px; z-index: 300;
  padding: 10px 18px; border-radius: var(--radius-xs);
  font-size: 12px; font-weight: 500; font-family: inherit;
  box-shadow: var(--shadow-lg); transform: translateY(80px); opacity: 0;
  transition: all 0.3s cubic-bezier(0.25,0.1,0.25,1);
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--green); color: white; }
.toast.error { background: var(--red); color: white; }
.toast.info { background: var(--blue); color: white; }

/* Settings status */
.settings-status {
  font-size: 10px; margin-top: 4px; min-height: 14px;
  transition: all 0.2s;
}

/* Provider cards */
.provider-card {
  background: var(--bg); border-radius: var(--radius-sm);
  padding: 14px 16px; margin-bottom: 8px; border: 0.5px solid var(--border);
  transition: all 0.2s;
}
.provider-card:hover { border-color: var(--border-strong); }
.provider-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
.provider-icon {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: white; flex-shrink: 0;
}
.provider-name { font-weight: 600; font-size: 13px; color: var(--text); flex: 1; }
.provider-badge {
  font-size: 9px; font-weight: 600; padding: 2px 7px; border-radius: 8px;
  text-transform: uppercase; letter-spacing: 0.3px;
}
.provider-badge.has-key { background: rgba(52,199,89,0.08); color: var(--green); }
.provider-badge.no-key { background: rgba(255,149,0,0.08); color: var(--orange); }
.provider-field {
  display: flex; align-items: center; gap: 6px;
  margin-bottom: 8px; font-size: 12px;
}
.provider-field-label {
  font-size: 10px; color: var(--text-tertiary); font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.3px; min-width: 55px; flex-shrink: 0;
}
.provider-field-value {
  flex: 1; min-width: 0; font-family: 'SF Mono', 'Menlo', monospace;
  font-size: 11px; color: var(--text-secondary);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.provider-input {
  flex: 1; padding: 5px 8px; border-radius: 6px;
  background: var(--bg-white); border: 0.5px solid var(--border);
  color: var(--text); font-size: 11px; font-family: 'SF Mono', 'Menlo', monospace;
  outline: none; transition: all 0.2s; min-width: 0;
}
.provider-input:focus { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }
.provider-input::placeholder { color: var(--text-tertiary); font-family: inherit; }
.provider-models-list {
  display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;
}
.provider-model-tag {
  font-size: 10px; padding: 2px 8px; border-radius: 6px;
  background: rgba(0,122,255,0.06); color: var(--blue); font-weight: 500;
  display: flex; align-items: center; gap: 4px;
}
.provider-model-tag .tag-remove {
  cursor: pointer; font-size: 12px; color: var(--text-tertiary);
  transition: color 0.15s; line-height: 1;
}
.provider-model-tag .tag-remove:hover { color: var(--red); }
.provider-actions {
  display: flex; gap: 6px; margin-top: 10px; padding-top: 10px;
  border-top: 0.5px solid var(--border);
}
.btn-icon {
  background: none; border: none; cursor: pointer;
  color: var(--text-tertiary); font-size: 13px; padding: 4px 6px;
  border-radius: 6px; transition: all 0.15s;
}
.btn-icon:hover { background: rgba(0,0,0,0.04); color: var(--text); }
.btn-icon.danger:hover { background: rgba(255,59,48,0.08); color: var(--red); }

/* Add provider form */
.add-provider-form {
  background: var(--bg); border-radius: var(--radius-sm);
  padding: 14px 16px; border: 1.5px dashed var(--border-strong);
  transition: all 0.2s;
}
.add-provider-form:focus-within { border-color: var(--blue); }
.add-provider-row {
  display: flex; gap: 6px; margin-bottom: 8px; align-items: center;
}
.add-provider-row:last-child { margin-bottom: 0; }
.add-provider-label {
  font-size: 10px; color: var(--text-tertiary); font-weight: 600;
  text-transform: uppercase; min-width: 55px; flex-shrink: 0;
}

/* ── DARK MODE OVERRIDES ── */
[data-theme="dark"] ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); }
[data-theme="dark"] ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

[data-theme="dark"] .toggle-track { background: #48484a; }
[data-theme="dark"] .toggle-knob { box-shadow: 0 1px 3px rgba(0,0,0,0.4); }

[data-theme="dark"] .kpi-pill { background: rgba(255,255,255,0.04); }
[data-theme="dark"] #live-clock { background: rgba(255,255,255,0.04); }
[data-theme="dark"] #btn-drawer { background: rgba(255,255,255,0.05); }
[data-theme="dark"] #btn-drawer:hover { background: rgba(255,255,255,0.08); }
[data-theme="dark"] #gw-badge.offline-badge { background: rgba(255,255,255,0.05); }

[data-theme="dark"] .ss-item { background: rgba(255,255,255,0.03); }
[data-theme="dark"] .ai-sessions { background: rgba(255,255,255,0.05); }

[data-theme="dark"] .agent-avatar .av-status { border-color: #2c2c2e; }
[data-theme="dark"] .av-status.offline { background: #48484a; }

[data-theme="dark"] .fstat-bar { background: rgba(255,255,255,0.06); }
[data-theme="dark"] .tbar { background: rgba(255,255,255,0.06); }

[data-theme="dark"] .stat-card { background: rgba(255,255,255,0.03); }

[data-theme="dark"] .mb.user { background: rgba(10,132,255,0.1); color: #a0c4ff; }
[data-theme="dark"] .mb.assistant { background: rgba(48,209,88,0.1); color: #80e6a0; }

[data-theme="dark"] .log-l.DEBUG { background: rgba(255,255,255,0.05); }
[data-theme="dark"] .log-l.INFO { background: rgba(10,132,255,0.12); }
[data-theme="dark"] .log-l.WARN { background: rgba(255,159,10,0.12); }
[data-theme="dark"] .log-l.ERROR { background: rgba(255,69,58,0.12); }

[data-theme="dark"] .btn-action.secondary { background: rgba(255,255,255,0.06); }
[data-theme="dark"] .btn-action.secondary:hover { background: rgba(255,255,255,0.1); }
[data-theme="dark"] .btn-icon:hover { background: rgba(255,255,255,0.06); }
[data-theme="dark"] #btn-dp-close { background: rgba(255,255,255,0.05); }
[data-theme="dark"] #btn-idr-close { background: rgba(255,255,255,0.05); }
[data-theme="dark"] #btn-send:disabled { background: #48484a; }

[data-theme="dark"] #task-form { background: rgba(255,255,255,0.02); }
[data-theme="dark"] #overlay { background: rgba(0,0,0,0.4); }
[data-theme="dark"] #detail-panel { box-shadow: -8px 0 30px rgba(0,0,0,0.3); }
[data-theme="dark"] #info-drawer { box-shadow: -8px 0 30px rgba(0,0,0,0.3); }

[data-theme="dark"] .cc-dot.off { background: #48484a; }
[data-theme="dark"] .cc-dot.disabled { background: #48484a; }

[data-theme="dark"] .provider-badge.has-key { background: rgba(48,209,88,0.12); }
[data-theme="dark"] .provider-badge.no-key { background: rgba(255,159,10,0.12); }
[data-theme="dark"] .provider-model-tag { background: rgba(10,132,255,0.1); }
[data-theme="dark"] .shdr-count { background: rgba(10,132,255,0.12); }
[data-theme="dark"] .add-provider-form { border-color: rgba(255,255,255,0.12); }

[data-theme="dark"] .platform-badge.telegram { background:rgba(0,136,204,0.15); }
[data-theme="dark"] .platform-badge.discord { background:rgba(88,101,242,0.15); }
[data-theme="dark"] .platform-badge.whatsapp { background:rgba(37,211,102,0.15); }
[data-theme="dark"] .platform-badge.none { background:rgba(255,255,255,0.05); }

[data-theme="dark"] .model-select,
[data-theme="dark"] .setting-select,
[data-theme="dark"] .cc-policy-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%23a1a1a6' stroke-width='1.5'/%3E%3C/svg%3E");
}

/* Theme toggle button */
#btn-theme {
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.04); border: none; color: var(--text-secondary);
  width: 32px; height: 32px; border-radius: var(--radius-xs);
  cursor: pointer; font-size: 15px; transition: all 0.2s;
}
#btn-theme:hover { background: rgba(0,0,0,0.07); color: var(--text); }
[data-theme="dark"] #btn-theme { background: rgba(255,255,255,0.05); }
[data-theme="dark"] #btn-theme:hover { background: rgba(255,255,255,0.08); }

/* ── DIRECTORY PICKER MODAL ── */
.dir-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.25); backdrop-filter: blur(4px);
}
.dir-overlay.show { display: flex; align-items: center; justify-content: center; }

.dir-modal {
  background: var(--bg-white); border-radius: var(--radius); box-shadow: var(--shadow-xl);
  width: 480px; max-height: 70vh; display: flex; flex-direction: column;
  overflow: hidden; animation: dirModalIn 0.2s ease;
}
@keyframes dirModalIn { from { opacity:0; transform: scale(0.96) translateY(8px); } to { opacity:1; transform: none; } }

.dir-modal-hdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px; border-bottom: 0.5px solid var(--border);
  font-size: 14px; font-weight: 600;
}
.dir-modal-hdr button {
  background: none; border: none; cursor: pointer; color: var(--text-tertiary);
  font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 6px;
  transition: all 0.15s;
}
.dir-modal-hdr button:hover { background: var(--bg-hover); color: var(--text); }

.dir-modal-path {
  padding: 10px 18px; font-size: 12px; color: var(--text-secondary);
  background: var(--bg); border-bottom: 0.5px solid var(--border);
  font-family: 'SF Mono', 'Fira Code', monospace; word-break: break-all;
}

.dir-modal-list {
  flex: 1; overflow-y: auto; padding: 4px 0; min-height: 200px;
}

.dir-modal-item {
  display: flex; align-items: center; gap: 10px; padding: 9px 18px;
  font-size: 13px; cursor: pointer; transition: background 0.1s;
  color: var(--text); border: none; background: none; width: 100%;
  text-align: left; font-family: inherit;
}
.dir-modal-item:hover { background: var(--bg-hover); }
.dir-modal-item .dir-icon { font-size: 16px; flex-shrink: 0; opacity: 0.7; }
.dir-modal-item.parent-dir { color: var(--text-secondary); font-weight: 500; }

.dir-modal-empty {
  padding: 30px 18px; text-align: center; color: var(--text-tertiary); font-size: 13px;
}

.dir-modal-footer {
  display: flex; align-items: center; gap: 8px; padding: 12px 18px;
  border-top: 0.5px solid var(--border); background: var(--bg);
}
.dir-modal-footer input {
  flex: 1; padding: 6px 10px; border-radius: var(--radius-xs);
  background: var(--bg-white); border: 0.5px solid var(--border-strong);
  color: var(--text); font-size: 12px; font-family: inherit; outline: none;
}
.dir-modal-footer input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }
.dir-modal-footer input::placeholder { color: var(--text-tertiary); }

.dir-modal-error {
  padding: 8px 18px; font-size: 12px; color: var(--red); background: rgba(255,59,48,0.06);
}

[data-theme="dark"] .dir-overlay { background: rgba(0,0,0,0.5); }

/* ── NAV BUTTONS ── */
.nav-btns { display: flex; gap: 4px; margin-left: 8px; }
.nav-btn {
  display: flex; align-items: center; gap: 5px;
  background: rgba(0,0,0,0.04); border: none; color: var(--text-secondary);
  padding: 6px 12px; border-radius: var(--radius-xs);
  cursor: pointer; font-size: 11px; font-family: inherit; font-weight: 500;
  transition: all 0.2s;
}
.nav-btn:hover { background: rgba(0,0,0,0.07); color: var(--text); }
.nav-btn.active { background: var(--blue); color: white; }
[data-theme="dark"] .nav-btn { background: rgba(255,255,255,0.05); }
[data-theme="dark"] .nav-btn:hover { background: rgba(255,255,255,0.08); }
[data-theme="dark"] .nav-btn.active { background: var(--blue); color: white; }

/* ── VIEW CONTAINERS ── */
.view-container {
  display: none; flex-direction: column; height: 100%;
  opacity: 0; transform: translateY(12px) scale(0.98);
}
.view-container.active {
  display: flex;
  animation: viewIn 0.4s cubic-bezier(0.25,0.1,0.25,1) forwards;
}
@keyframes viewIn {
  from { opacity:0; transform: translateY(12px) scale(0.98); }
  to { opacity:1; transform: translateY(0) scale(1); }
}
.view-container.view-exit {
  display: flex;
  animation: viewOut 0.25s cubic-bezier(0.25,0.1,0.25,1) forwards;
}
@keyframes viewOut {
  from { opacity:1; transform: translateY(0) scale(1); }
  to { opacity:0; transform: translateY(-8px) scale(0.98); }
}
#view-office.active { flex-direction: column; }

/* ── HERO BANNER ── */
.hero-banner {
  position: relative; overflow: hidden;
  padding: 24px 20px; margin: 0 14px 0; flex-shrink: 0;
  border-radius: var(--radius); min-height: 90px;
  background: linear-gradient(-45deg, #007aff, #5856d6, #af52de, #ff2d55, #ff9500, #34c759);
  background-size: 400% 400%;
  animation: heroGradient 12s ease infinite;
}
@keyframes heroGradient {
  0%{background-position:0% 50%} 25%{background-position:100% 50%} 50%{background-position:100% 0%} 75%{background-position:0% 100%} 100%{background-position:0% 50%}
}
.hero-banner canvas.hero-particles {
  position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;
}
.hero-content {
  position: relative; z-index: 2; display: flex; align-items: center; gap: 16px;
}
.hero-icon {
  width: 48px; height: 48px; border-radius: 14px;
  background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; animation: heroFloat 3s ease-in-out infinite;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}
@keyframes heroFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
.hero-text { flex: 1; }
.hero-title {
  font-size: 17px; font-weight: 700; color: white; letter-spacing: -0.3px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.15);
}
.hero-sub {
  font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 3px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.hero-live-dot {
  width: 8px; height: 8px; border-radius: 50%; background: #30d158;
  box-shadow: 0 0 8px rgba(48,209,88,0.6);
  animation: heroPulse 2s ease-in-out infinite;
}
@keyframes heroPulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.6;transform:scale(0.85)} }
[data-theme="dark"] .hero-banner {
  background: linear-gradient(-45deg, #0a84ff, #5e5ce6, #bf5af2, #ff375f, #ff9f0a, #30d158);
  background-size: 400% 400%;
}

/* ── WAVE DIVIDER ── */
.hero-wave {
  position: absolute; bottom: -1px; left: 0; right: 0; height: 20px; z-index: 2;
}
.hero-wave svg { display: block; width: 100%; height: 100%; }
.hero-wave path { fill: var(--bg); }

/* ── ACTIVITY TICKER ── */
.activity-ticker {
  position: relative; overflow: hidden; flex-shrink: 0;
  height: 32px; background: var(--bg-white);
  border-top: 0.5px solid var(--border);
  border-bottom: 0.5px solid var(--border);
}
.ticker-track {
  display: flex; align-items: center; height: 100%;
  animation: tickerScroll var(--ticker-duration, 30s) linear infinite;
  white-space: nowrap; gap: 24px; padding-left: 100%;
}
.activity-ticker:hover .ticker-track { animation-play-state: paused; }
@keyframes tickerScroll { from{transform:translateX(0)} to{transform:translateX(-50%)} }
.ticker-item {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--text-secondary); flex-shrink: 0;
}
.ticker-dot {
  width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0;
}
.ticker-dot.busy { background: var(--blue); }
.ticker-dot.idle { background: var(--green); }
.ticker-dot.inactive { background: var(--orange); }
.ticker-dot.offline { background: var(--text-tertiary); }
.ticker-name { font-weight: 600; color: var(--text); }
.ticker-sep { color: var(--text-tertiary); font-size: 8px; }

/* ── TASK MANAGER ── */
.task-filters {
  display: flex; gap: 6px; padding: 12px 14px; flex-shrink: 0;
  flex-wrap: wrap; align-items: center;
}
.filter-pill {
  padding: 5px 12px; border-radius: 16px; font-size: 11px; font-weight: 500;
  background: rgba(0,0,0,0.04); color: var(--text-secondary);
  border: none; cursor: pointer; transition: all 0.15s; font-family: inherit;
}
.filter-pill:hover { background: rgba(0,0,0,0.07); }
.filter-pill.active { background: var(--blue); color: white; }
.filter-sep { width: 1px; height: 20px; background: var(--border-strong); margin: 0 4px; }
[data-theme="dark"] .filter-pill { background: rgba(255,255,255,0.05); }
[data-theme="dark"] .filter-pill:hover { background: rgba(255,255,255,0.08); }
[data-theme="dark"] .filter-pill.active { background: var(--blue); color: white; }

.task-content { flex: 1; overflow-y: auto; padding: 0 14px 14px; }

.task-section-hdr {
  display: flex; align-items: center; gap: 8px; margin: 12px 0 8px;
  cursor: pointer; user-select: none;
}
.task-section-hdr .tsh-icon { font-size: 10px; color: var(--text-tertiary); transition: transform 0.2s; }
.task-section-hdr .tsh-icon.collapsed { transform: rotate(-90deg); }
.task-section-hdr .tsh-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
.task-section-hdr .tsh-count { font-size: 10px; color: var(--text-tertiary); font-weight: 600; }

.task-card {
  background: var(--bg-white); border-radius: var(--radius-sm); padding: 14px 16px;
  box-shadow: var(--shadow-sm); border: 0.5px solid var(--border);
  margin-bottom: 8px; transition: all 0.25s cubic-bezier(0.25,0.1,0.25,1); cursor: default;
  animation: taskCardIn 0.35s cubic-bezier(0.25,0.1,0.25,1) backwards;
}
.task-card:nth-child(2) { animation-delay: 0.05s; }
.task-card:nth-child(3) { animation-delay: 0.1s; }
.task-card:nth-child(4) { animation-delay: 0.15s; }
.task-card:nth-child(5) { animation-delay: 0.2s; }
@keyframes taskCardIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.task-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.task-card-top { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
.task-card-title { flex: 1; font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.4; }
.task-card-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px; }
.task-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }

.priority-badge {
  font-size: 9px; font-weight: 700; padding: 2px 8px; border-radius: 8px;
  text-transform: uppercase; letter-spacing: 0.3px;
}
.priority-badge.urgent { background: rgba(255,59,48,0.1); color: var(--red); }
.priority-badge.high { background: rgba(255,149,0,0.1); color: var(--orange); }
.priority-badge.medium { background: rgba(0,122,255,0.08); color: var(--blue); }
.priority-badge.low { background: rgba(0,0,0,0.04); color: var(--text-tertiary); }
[data-theme="dark"] .priority-badge.urgent { background: rgba(255,69,58,0.15); }
[data-theme="dark"] .priority-badge.high { background: rgba(255,159,10,0.15); }
[data-theme="dark"] .priority-badge.medium { background: rgba(10,132,255,0.12); }
[data-theme="dark"] .priority-badge.low { background: rgba(255,255,255,0.06); }

.agent-badge-sm {
  font-size: 9px; font-weight: 600; padding: 2px 8px; border-radius: 8px;
  background: rgba(175,82,222,0.08); color: var(--purple);
}
[data-theme="dark"] .agent-badge-sm { background: rgba(191,90,242,0.12); }

.due-badge {
  font-size: 9px; font-weight: 500; padding: 2px 8px; border-radius: 8px;
  background: rgba(0,0,0,0.03); color: var(--text-tertiary);
}
.due-badge.overdue { background: rgba(255,59,48,0.08); color: var(--red); }
[data-theme="dark"] .due-badge { background: rgba(255,255,255,0.04); }
[data-theme="dark"] .due-badge.overdue { background: rgba(255,69,58,0.12); }

.task-card-actions { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }
.task-action-btn {
  background: rgba(0,0,0,0.03); border: none; cursor: pointer;
  font-size: 11px; padding: 4px 8px; border-radius: 6px;
  color: var(--text-tertiary); transition: all 0.15s; font-family: inherit;
}
.task-action-btn:hover { background: rgba(0,0,0,0.06); color: var(--text); }
.task-action-btn.complete:hover { background: rgba(52,199,89,0.1); color: var(--green); }
.task-action-btn.delete:hover { background: rgba(255,59,48,0.08); color: var(--red); }
[data-theme="dark"] .task-action-btn { background: rgba(255,255,255,0.04); }
[data-theme="dark"] .task-action-btn:hover { background: rgba(255,255,255,0.08); }

.task-stats-bar {
  display: flex; gap: 8px; padding: 12px 14px; flex-shrink: 0;
  border-top: 0.5px solid var(--border); background: var(--bg);
}
.task-stat-item {
  display: flex; align-items: center; gap: 5px;
  font-size: 11px; color: var(--text-secondary);
}
.task-stat-num { font-weight: 700; color: var(--text); }

/* ── TASK/CALENDAR MODAL ── */
.modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.25); backdrop-filter: blur(4px);
}
.modal-overlay.show { display: flex; align-items: center; justify-content: center; }
[data-theme="dark"] .modal-overlay { background: rgba(0,0,0,0.5); }

.modal-box {
  background: var(--bg-white); border-radius: var(--radius); box-shadow: var(--shadow-xl);
  width: 440px; max-height: 80vh; overflow-y: auto;
  animation: dirModalIn 0.2s ease;
}
.modal-box-hdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px; border-bottom: 0.5px solid var(--border);
  font-size: 15px; font-weight: 600;
}
.modal-box-hdr button {
  background: none; border: none; cursor: pointer; color: var(--text-tertiary);
  font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 6px;
  transition: all 0.15s;
}
.modal-box-hdr button:hover { background: var(--bg-hover); color: var(--text); }
.modal-body { padding: 16px 20px; }
.modal-field { margin-bottom: 14px; }
.modal-field label {
  display: block; font-size: 11px; font-weight: 600; color: var(--text-secondary);
  margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;
}
.modal-field input, .modal-field textarea, .modal-field select {
  width: 100%; padding: 8px 12px; border-radius: var(--radius-xs);
  background: var(--bg); border: 0.5px solid var(--border-strong);
  color: var(--text); font-size: 13px; font-family: inherit;
  outline: none; transition: all 0.2s;
}
.modal-field textarea { resize: vertical; min-height: 60px; }
.modal-field input:focus, .modal-field textarea:focus, .modal-field select:focus {
  border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,0.12);
}
.modal-field select { appearance: none; cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%236e6e73' stroke-width='1.5'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
.modal-row { display: flex; gap: 10px; }
.modal-row .modal-field { flex: 1; }
.modal-footer { padding: 0 20px 16px; display: flex; justify-content: flex-end; gap: 8px; }

/* ── CALENDAR ── */
.cal-header {
  display: flex; align-items: center; gap: 12px; padding: 12px 14px; flex-shrink: 0;
}
.cal-nav-btn {
  background: rgba(0,0,0,0.04); border: none; cursor: pointer;
  width: 32px; height: 32px; border-radius: var(--radius-xs);
  font-size: 14px; color: var(--text-secondary); transition: all 0.15s;
  display: flex; align-items: center; justify-content: center;
}
.cal-nav-btn:hover { background: rgba(0,0,0,0.07); color: var(--text); }
[data-theme="dark"] .cal-nav-btn { background: rgba(255,255,255,0.05); }
[data-theme="dark"] .cal-nav-btn:hover { background: rgba(255,255,255,0.08); }
.cal-month-label { font-size: 17px; font-weight: 700; color: var(--text); flex: 1; }

.cal-grid-wrap { flex: 1; overflow-y: auto; padding: 0 14px 14px; }
.cal-grid {
  display: grid; grid-template-columns: repeat(7, 1fr);
  gap: 4px; width: 100%;
}
.cal-day-hdr {
  text-align: center; font-size: 10px; font-weight: 700;
  color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px;
  padding: 6px 0;
}
.cal-day {
  min-height: 80px; background: var(--bg-white); border-radius: var(--radius-xs);
  padding: 6px 8px; border: 0.5px solid var(--border); transition: all 0.2s;
  cursor: default; animation: calDayIn 0.3s cubic-bezier(0.25,0.1,0.25,1) backwards;
}
@keyframes calDayIn { from{opacity:0;transform:scale(0.92)} to{opacity:1;transform:scale(1)} }
.cal-day:hover { border-color: var(--border-strong); box-shadow: var(--shadow-sm); transform: scale(1.02); }
.cal-day.other-month { opacity: 0.35; }
.cal-day.today { border-color: var(--blue); box-shadow: 0 0 0 1px var(--blue); }
.cal-day-num { font-size: 11px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.cal-day.today .cal-day-num { color: var(--blue); font-weight: 800; }
.cal-event-pill {
  font-size: 9px; font-weight: 500; padding: 2px 6px; border-radius: 6px;
  margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  cursor: pointer; transition: opacity 0.15s;
}
.cal-event-pill:hover { opacity: 0.8; }
.cal-event-pill.meeting { background: rgba(175,82,222,0.12); color: var(--purple); }
.cal-event-pill.deadline { background: rgba(255,59,48,0.1); color: var(--red); }
.cal-event-pill.reminder { background: rgba(0,122,255,0.08); color: var(--blue); }
[data-theme="dark"] .cal-event-pill.meeting { background: rgba(191,90,242,0.18); }
[data-theme="dark"] .cal-event-pill.deadline { background: rgba(255,69,58,0.15); }
[data-theme="dark"] .cal-event-pill.reminder { background: rgba(10,132,255,0.12); }

/* ── PROFILE EDITOR ── */
.profile-section { margin-bottom: 16px; }
.profile-section-hdr {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px;
}
.profile-section-title { font-size: 12px; font-weight: 700; color: var(--text); }
.profile-save-btn {
  padding: 4px 12px; border-radius: 6px; border: none;
  background: var(--blue); color: white; font-size: 10px; font-weight: 600;
  cursor: pointer; font-family: inherit; transition: all 0.15s;
}
.profile-save-btn:hover { background: #0066d6; }
.profile-save-btn:disabled { background: #c7c7cc; cursor: not-allowed; }
.profile-save-btn.saved { background: var(--green); }
.profile-textarea {
  width: 100%; min-height: 120px; padding: 10px 12px;
  background: var(--bg); border: 0.5px solid var(--border-strong);
  border-radius: var(--radius-xs); color: var(--text);
  font-size: 11px; font-family: 'SF Mono', 'Menlo', 'Fira Code', monospace;
  line-height: 1.6; resize: vertical; outline: none; transition: all 0.2s;
}
.profile-textarea:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }
.profile-info {
  background: var(--bg-white); border-radius: var(--radius-xs); padding: 12px 14px;
  border: 0.5px solid var(--border); margin-top: 16px;
}
.profile-info-row { display: flex; justify-content: space-between; font-size: 11px; padding: 4px 0; color: var(--text-secondary); }
.profile-info-row .v { color: var(--text); font-weight: 600; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="logo-section">
    <div class="logo-icon">&#x1F99E;</div>
    <div>
      <div class="logo-text">OpenClaw HQ</div>
      <div class="logo-sub">Virtual Office</div>
    </div>
  </div>
  <div id="gw-badge">
    <div id="gw-dot"></div>
    <span id="gw-lbl">Connecting...</span>
  </div>
  <div class="topbar-kpis">
    <div class="kpi-pill"><div class="kpi-dot blue"></div><span>Active</span><span class="kpi-val" id="kpi-active">0</span></div>
    <div class="kpi-pill"><div class="kpi-dot green"></div><span>Sessions</span><span class="kpi-val" id="kpi-sessions">0</span></div>
  </div>
  <div class="nav-btns">
    <button class="nav-btn active" id="nav-office" onclick="switchView('office')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Office
    </button>
    <button class="nav-btn" id="nav-tasks" onclick="switchView('tasks')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Tasks
    </button>
    <button class="nav-btn" id="nav-calendar" onclick="switchView('calendar')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Calendar
    </button>
  </div>
  <div class="topbar-right">
    <span id="topbar-meta"></span>
    <span id="live-clock"></span>
    <button id="btn-theme" onclick="toggleTheme()" title="Toggle dark mode">
      <svg id="theme-icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      <svg id="theme-icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="display:none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
    </button>
    <button id="btn-drawer" onclick="toggleDrawer()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      Settings
    </button>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div id="sidebar-hdr">
    <span class="shdr-label">Agents</span>
    <span class="shdr-count" id="agent-count">0</span>
  </div>
  <div id="sidebar-stats">
    <div class="ss-item"><span class="ss-num busy" id="ss-busy">0</span><span class="ss-lbl">Busy</span></div>
    <div class="ss-item"><span class="ss-num idle" id="ss-idle">0</span><span class="ss-lbl">Idle</span></div>
    <div class="ss-item"><span class="ss-num inactive" id="ss-inact">0</span><span class="ss-lbl">Away</span></div>
    <div class="ss-item"><span class="ss-num offline" id="ss-off">0</span><span class="ss-lbl">Off</span></div>
  </div>
  <div id="agent-list"></div>
</div>

<!-- MAIN AREA -->
<div id="main-area">
  <!-- OFFICE VIEW (default) -->
  <div id="view-office" class="view-container active">
    <!-- HERO BANNER -->
    <div class="hero-banner">
      <canvas class="hero-particles" id="hero-particles"></canvas>
      <div class="hero-content">
        <div class="hero-icon">&#x1F99E;</div>
        <div class="hero-text">
          <div class="hero-title" id="hero-title">OpenClaw HQ</div>
          <div class="hero-sub" id="hero-sub">Loading system status...</div>
        </div>
        <div class="hero-live-dot" id="hero-dot"></div>
      </div>
      <div class="hero-wave"><svg viewBox="0 0 1200 20" preserveAspectRatio="none"><path d="M0,10 C200,20 400,0 600,10 C800,20 1000,0 1200,10 L1200,20 L0,20 Z"/></svg></div>
    </div>
    <!-- ACTIVITY TICKER -->
    <div class="activity-ticker">
      <div class="ticker-track" id="ticker-track"></div>
    </div>
    <div id="float-stats">
      <div class="fstat">
        <div class="fstat-label">Active Agents</div>
        <div class="fstat-row"><span class="fstat-value" id="fs-active">0</span><span class="fstat-unit">/ <span id="fs-total">0</span></span></div>
        <div class="fstat-bar"><div class="fstat-bar-fill" id="fs-active-bar" style="width:0;background:linear-gradient(90deg,#007aff,#5ac8fa)"></div></div>
      </div>
      <div class="fstat">
        <div class="fstat-label">Total Sessions</div>
        <div class="fstat-row"><span class="fstat-value" id="fs-sessions">0</span><span class="fstat-unit">sessions</span></div>
        <div class="fstat-bar"><div class="fstat-bar-fill" id="fs-sess-bar" style="width:0;background:linear-gradient(90deg,#34c759,#30d158)"></div></div>
      </div>
      <div class="fstat">
        <div class="fstat-label">Gateway</div>
        <div class="fstat-row"><span class="fstat-value" id="fs-gw-status">--</span><span class="fstat-unit" id="fs-gw-uptime"></span></div>
        <div class="fstat-bar"><div class="fstat-bar-fill" id="fs-gw-bar" style="width:0;background:linear-gradient(90deg,#ff9500,#ffb340)"></div></div>
      </div>
      <div class="fstat">
        <div class="fstat-label">Channels</div>
        <div class="fstat-row"><span class="fstat-value" id="fs-channels">--</span><span class="fstat-unit" id="fs-ch-detail">running</span></div>
        <div class="fstat-bar"><div class="fstat-bar-fill" id="fs-ch-bar" style="width:0;background:linear-gradient(90deg,#af52de,#da8fff)"></div></div>
      </div>
    </div>
    <div id="canvas-wrap">
      <canvas id="office"></canvas>
    </div>
  </div>

  <!-- TASKS VIEW -->
  <div id="view-tasks" class="view-container">
    <div class="task-filters" id="task-filters"></div>
    <div class="task-content" id="task-content"></div>
    <div class="task-stats-bar" id="task-stats-bar"></div>
  </div>

  <!-- CALENDAR VIEW -->
  <div id="view-calendar" class="view-container">
    <div class="cal-header">
      <button class="cal-nav-btn" onclick="calNavMonth(-1)">&#x276E;</button>
      <span class="cal-month-label" id="cal-month-label"></span>
      <button class="cal-nav-btn" onclick="calNavMonth(1)">&#x276F;</button>
      <div style="flex:1"></div>
      <button class="btn-action primary" onclick="openCalendarModal()">+ New Event</button>
    </div>
    <div class="cal-grid-wrap">
      <div class="cal-grid" id="cal-grid"></div>
    </div>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay" onclick="closeDetail()"></div>

<!-- DIRECTORY PICKER MODAL -->
<div class="dir-overlay" id="dir-overlay" onclick="if(event.target===this)closeDirBrowser()">
  <div class="dir-modal">
    <div class="dir-modal-hdr">
      <span>Select Directory</span>
      <button onclick="closeDirBrowser()">&times;</button>
    </div>
    <div class="dir-modal-path" id="dir-current-path">/</div>
    <div class="dir-modal-error" id="dir-error" style="display:none"></div>
    <div class="dir-modal-list" id="dir-list"></div>
    <div class="dir-modal-footer">
      <input type="text" id="dir-new-name" placeholder="New folder name...">
      <button class="btn-action secondary" onclick="createBackupDir()">New Folder</button>
      <button class="btn-action primary" onclick="selectDir()">Select</button>
    </div>
  </div>
</div>

<!-- DETAIL PANEL -->
<div id="detail-panel">
  <div id="dp-hdr">
    <div id="dp-avatar-lg"></div>
    <div id="dp-info">
      <div id="dp-name">--</div>
      <div id="dp-model"></div>
    </div>
    <span id="dp-status-badge"></span>
    <button id="btn-dp-close" onclick="closeDetail()">&#x2715;</button>
  </div>
  <div id="dp-tabs">
    <div class="dtab act" onclick="switchTab('overview')">Overview</div>
    <div class="dtab" onclick="switchTab('messages')">Messages</div>
    <div class="dtab" onclick="switchTab('profile')">Profile</div>
    <div class="dtab" onclick="switchTab('task')">Send Task</div>
  </div>
  <div id="dp-body"></div>
  <div id="task-form">
    <label>Send message to agent</label>
    <textarea id="task-input" placeholder="Type a task or message..."></textarea>
    <button id="btn-send" onclick="sendTask()">Send Message</button>
    <div id="task-ok"></div>
    <div id="task-err"></div>
  </div>
</div>

<!-- SETTINGS DRAWER -->
<div id="info-drawer">
  <div id="idr-hdr">
    <span>Settings</span>
    <button id="btn-idr-close" onclick="toggleDrawer()">&#x2715;</button>
  </div>
  <div id="idr-body">

    <!-- Gateway Control -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x26A1;</span> Gateway</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Service Status</div>
          <div class="setting-sublabel" id="gw-service-status">Checking...</div>
        </div>
        <div class="btn-group">
          <button class="btn-action success" onclick="gatewayAction('start')" id="btn-gw-start">Start</button>
          <button class="btn-action primary" onclick="gatewayAction('restart')" id="btn-gw-restart">Restart</button>
          <button class="btn-action danger" onclick="gatewayAction('stop')" id="btn-gw-stop">Stop</button>
        </div>
      </div>
    </div>

    <!-- Default Model -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x1F9E0;</span> Default Model</div>
      <div class="setting-row">
        <div class="setting-label">Primary Model</div>
        <select class="setting-select" id="settings-primary-model" onchange="saveDefaultModel()"></select>
      </div>
      <div class="settings-status" id="default-model-status"></div>
      <div style="margin-top:12px">
        <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Fallback Chain</div>
        <div class="fallback-list" id="fallback-list"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <select class="setting-select" id="add-fallback-select" style="flex:1;min-width:0"></select>
          <button class="btn-action secondary" onclick="addFallback()">+ Add</button>
        </div>
      </div>
    </div>

    <!-- Compaction -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x1F504;</span> Compaction</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Compaction Mode</div>
          <div class="setting-sublabel">How context is managed when limit is reached</div>
        </div>
        <select class="setting-select" id="settings-compaction" onchange="saveCompaction()">
          <option value="safeguard">Safeguard</option>
          <option value="full">Full</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div class="settings-status" id="compaction-status"></div>
    </div>

    <!-- Models & API Keys -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x1F511;</span> Models & API Keys</div>
      <div id="providers-list"></div>
      <div class="add-provider-form" id="add-provider-form" style="margin-top:10px">
        <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Add Provider</div>
        <div class="add-provider-row">
          <span class="add-provider-label">Name</span>
          <input class="provider-input" id="new-provider-name" placeholder="e.g. anthropic, openai">
        </div>
        <div class="add-provider-row">
          <span class="add-provider-label">API Key</span>
          <input class="provider-input" id="new-provider-key" placeholder="sk-..." type="password">
          <button class="btn-icon" onclick="toggleNewKeyVis()" title="Show/Hide">&#x1F441;</button>
        </div>
        <div class="add-provider-row">
          <span class="add-provider-label">Base URL</span>
          <input class="provider-input" id="new-provider-url" placeholder="https://api.example.com (optional)">
        </div>
        <div class="add-provider-row">
          <span class="add-provider-label">Models</span>
          <input class="provider-input" id="new-provider-models" list="all-models-datalist" placeholder="model-1, model-2 (comma separated)">
          <datalist id="all-models-datalist"></datalist>
        </div>
        <div class="add-provider-row" style="justify-content:flex-end">
          <button class="btn-action primary" onclick="addProvider()">Add Provider</button>
        </div>
      </div>
      <div class="settings-status" id="provider-status"></div>
    </div>

    <!-- Channels -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x1F4E1;</span> Telegram Channels</div>
      <div id="settings-channels"></div>
    </div>

    <!-- MD File Backup -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x1F4BE;</span> MD File Backup</div>
      <div class="setting-row">
        <div class="setting-label">Target Path</div>
        <input type="hidden" id="backup-path">
        <span id="backup-path-display" style="font-size:12px;color:var(--text-secondary);font-family:'SF Mono','Fira Code',monospace;margin-right:8px;word-break:break-all;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="">Not set</span>
        <button class="btn-action secondary" onclick="openDirBrowser()">Browse...</button>
      </div>
      <div class="setting-row">
        <div class="setting-label">Auto Backup</div>
        <label class="toggle-switch">
          <input type="checkbox" id="backup-enabled" onchange="saveBackupSettings()">
          <div class="toggle-track"></div>
          <div class="toggle-knob"></div>
        </label>
      </div>
      <div class="setting-row">
        <div class="setting-label">Interval</div>
        <select class="setting-select" id="backup-interval" onchange="saveBackupSettings()">
          <option value="15">15 min</option>
          <option value="30">30 min</option>
          <option value="60">1 hour</option>
          <option value="120">2 hours</option>
          <option value="360">6 hours</option>
          <option value="720">12 hours</option>
          <option value="1440">24 hours</option>
        </select>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Export Now</div>
          <div class="setting-sublabel" id="backup-last-info">No backup yet</div>
        </div>
        <button class="btn-action primary" id="btn-backup-export" onclick="triggerBackupExport()">Export Now</button>
      </div>
      <div class="settings-status" id="backup-status"></div>
    </div>

    <!-- Sessions -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x1F4C2;</span> Sessions</div>
      <div id="se-info"></div>
    </div>

    <!-- Live Logs -->
    <div class="settings-group">
      <div class="sg-title"><span class="sg-icon">&#x1F4DC;</span> Live Logs</div>
      <div id="log-wrap"></div>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- TASK MODAL -->
<div class="modal-overlay" id="task-modal" onclick="if(event.target===this)closeTaskModal()">
  <div class="modal-box">
    <div class="modal-box-hdr"><span>New Task</span><button onclick="closeTaskModal()">&times;</button></div>
    <div class="modal-body">
      <div class="modal-field"><label>Title</label><input id="tm-title" placeholder="Task title..."></div>
      <div class="modal-field"><label>Description</label><textarea id="tm-desc" placeholder="Optional description..."></textarea></div>
      <div class="modal-row">
        <div class="modal-field"><label>Assign To</label><select id="tm-agent"><option value="">Unassigned</option></select></div>
        <div class="modal-field"><label>Priority</label>
          <select id="tm-priority"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="urgent">Urgent</option></select>
        </div>
      </div>
      <div class="modal-field"><label>Due Date</label><input type="date" id="tm-due"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-action secondary" onclick="closeTaskModal()">Cancel</button>
      <button class="btn-action primary" onclick="createTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- CALENDAR MODAL -->
<div class="modal-overlay" id="cal-modal" onclick="if(event.target===this)closeCalendarModal()">
  <div class="modal-box">
    <div class="modal-box-hdr"><span>New Event</span><button onclick="closeCalendarModal()">&times;</button></div>
    <div class="modal-body">
      <div class="modal-field"><label>Title</label><input id="cm-title" placeholder="Event title..."></div>
      <div class="modal-field"><label>Description</label><textarea id="cm-desc" placeholder="Optional description..."></textarea></div>
      <div class="modal-row">
        <div class="modal-field"><label>Date</label><input type="date" id="cm-date"></div>
        <div class="modal-field"><label>Time</label><input type="time" id="cm-time" value="09:00"></div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label>Agent</label><select id="cm-agent"><option value="all">All Agents</option></select></div>
        <div class="modal-field"><label>Type</label>
          <select id="cm-type"><option value="meeting">Meeting</option><option value="deadline">Deadline</option><option value="reminder" selected>Reminder</option></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-action secondary" onclick="closeCalendarModal()">Cancel</button>
      <button class="btn-action primary" onclick="createCalEvent()">Create Event</button>
    </div>
  </div>
</div>

<script>
/* ── THEME ── */
function getPreferredTheme() {
  const stored = localStorage.getItem('theme');
  if (stored) return stored;
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
  const sun = document.getElementById('theme-icon-sun');
  const moon = document.getElementById('theme-icon-moon');
  if (sun) sun.style.display = theme === 'dark' ? 'none' : 'block';
  if (moon) moon.style.display = theme === 'dark' ? 'block' : 'none';
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.classList.add('theme-transition');
  applyTheme(next);
  setTimeout(() => document.documentElement.classList.remove('theme-transition'), 400);
}
function isDarkMode() { return document.documentElement.getAttribute('data-theme') === 'dark'; }
applyTheme(getPreferredTheme());
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  if (!localStorage.getItem('theme')) applyTheme(e.matches ? 'dark' : 'light');
});

const AGENT_CELLS = {
  kate:{col:0,row:0}, main:{col:1,row:0}, nova:{col:2,row:0},
  dona:{col:0,row:1},                      tom: {col:2,row:1},
  jack:{col:0,row:2}, raven:{col:1,row:2},
};

/* Pastel room themes per status */
const STATUS_THEMES = {
  busy: {
    floor:'#eef4ff', wall:'#dbeafe', wallTop:'#bfdbfe',
    accent:'#3b82f6', accentLight:'#93c5fd', label:'#1e40af',
    text:'#1e3a8a', glow:'rgba(59,130,246,0.08)', border:'rgba(59,130,246,0.15)'
  },
  idle: {
    floor:'#f0fdf4', wall:'#dcfce7', wallTop:'#bbf7d0',
    accent:'#22c55e', accentLight:'#86efac', label:'#166534',
    text:'#14532d', glow:'rgba(34,197,94,0.06)', border:'rgba(34,197,94,0.12)'
  },
  inactive: {
    floor:'#fffbeb', wall:'#fef3c7', wallTop:'#fde68a',
    accent:'#f59e0b', accentLight:'#fcd34d', label:'#92400e',
    text:'#78350f', glow:'rgba(245,158,11,0.06)', border:'rgba(245,158,11,0.12)'
  },
  offline: {
    floor:'#f9fafb', wall:'#f3f4f6', wallTop:'#e5e7eb',
    accent:'#9ca3af', accentLight:'#d1d5db', label:'#374151',
    text:'#6b7280', glow:'transparent', border:'rgba(0,0,0,0.05)'
  },
};

/* Pastel agent palettes */
const PALETTES = {
  kate: {body:'#f472b6', eye:'#1e1b4b', shirt:'#ec4899', accent:'#f9a8d4', bg:'#fce7f3', bgSolid:'#fdf2f8', dark:'#be185d'},
  main: {body:'#60a5fa', eye:'#1e1b4b', shirt:'#3b82f6', accent:'#93c5fd', bg:'#dbeafe', bgSolid:'#eff6ff', dark:'#1d4ed8'},
  nova: {body:'#a78bfa', eye:'#1e1b4b', shirt:'#8b5cf6', accent:'#c4b5fd', bg:'#ede9fe', bgSolid:'#f5f3ff', dark:'#6d28d9'},
  dona: {body:'#4ade80', eye:'#1e1b4b', shirt:'#22c55e', accent:'#86efac', bg:'#dcfce7', bgSolid:'#f0fdf4', dark:'#15803d'},
  tom:  {body:'#fbbf24', eye:'#1e1b4b', shirt:'#f59e0b', accent:'#fde68a', bg:'#fef3c7', bgSolid:'#fffbeb', dark:'#b45309'},
  jack: {body:'#2dd4bf', eye:'#1e1b4b', shirt:'#14b8a6', accent:'#99f6e4', bg:'#ccfbf1', bgSolid:'#f0fdfa', dark:'#0f766e'},
  raven:{body:'#818cf8', eye:'#1e1b4b', shirt:'#6366f1', accent:'#a5b4fc', bg:'#e0e7ff', bgSolid:'#eef2ff', dark:'#4338ca'},
};

const STATUS_THEMES_DARK = {
  busy: {
    floor:'#1a2332', wall:'#1e293b', wallTop:'#0f172a',
    accent:'#3b82f6', accentLight:'#60a5fa', label:'#93c5fd',
    text:'#bfdbfe', glow:'rgba(59,130,246,0.15)', border:'rgba(59,130,246,0.25)'
  },
  idle: {
    floor:'#162321', wall:'#1a2e25', wallTop:'#0f1f17',
    accent:'#22c55e', accentLight:'#4ade80', label:'#86efac',
    text:'#bbf7d0', glow:'rgba(34,197,94,0.12)', border:'rgba(34,197,94,0.2)'
  },
  inactive: {
    floor:'#27200e', wall:'#2d2510', wallTop:'#1f1a0a',
    accent:'#f59e0b', accentLight:'#fbbf24', label:'#fcd34d',
    text:'#fde68a', glow:'rgba(245,158,11,0.12)', border:'rgba(245,158,11,0.2)'
  },
  offline: {
    floor:'#1c1c1e', wall:'#2c2c2e', wallTop:'#1c1c1e',
    accent:'#636366', accentLight:'#48484a', label:'#a1a1a6',
    text:'#8e8e93', glow:'transparent', border:'rgba(255,255,255,0.05)'
  },
};

const PALETTES_DARK = {
  kate: {body:'#f472b6', eye:'#f5f5f7', shirt:'#ec4899', accent:'#f9a8d4', bg:'#3b1530', bgSolid:'#2d1024', dark:'#f9a8d4'},
  main: {body:'#60a5fa', eye:'#f5f5f7', shirt:'#3b82f6', accent:'#93c5fd', bg:'#1a2744', bgSolid:'#132035', dark:'#93c5fd'},
  nova: {body:'#a78bfa', eye:'#f5f5f7', shirt:'#8b5cf6', accent:'#c4b5fd', bg:'#291e48', bgSolid:'#1f1638', dark:'#c4b5fd'},
  dona: {body:'#4ade80', eye:'#f5f5f7', shirt:'#22c55e', accent:'#86efac', bg:'#14301b', bgSolid:'#0d2313', dark:'#86efac'},
  tom:  {body:'#fbbf24', eye:'#f5f5f7', shirt:'#f59e0b', accent:'#fde68a', bg:'#2d230a', bgSolid:'#221a07', dark:'#fde68a'},
  jack: {body:'#2dd4bf', eye:'#f5f5f7', shirt:'#14b8a6', accent:'#99f6e4', bg:'#0f2a25', bgSolid:'#0a1f1b', dark:'#99f6e4'},
  raven:{body:'#818cf8', eye:'#f5f5f7', shirt:'#6366f1', accent:'#a5b4fc', bg:'#1e1e46', bgSolid:'#161636', dark:'#a5b4fc'},
};

const MEETING_THEME = {
  light: {bg:'#faf5ff', wallTop:'#f3e8ff', wallBot:'#faf5ff', glow:'rgba(139,92,246,0.12)', glowIdle:'rgba(139,92,246,0.04)',
    badge:'#f3e8ff', badgeText:'#7c3aed', table:'#ede9fe', tableStroke:'rgba(139,92,246,0.2)',
    projBg:'#f5f3ff', projIdle:'#faf8ff', projStroke:'rgba(139,92,246,0.18)',
    barColors:['#e9d5ff','#d8b4fe','#c084fc','#a855f7','#9333ea','#a855f7','#c084fc','#d8b4fe'],
    ledActive:'#8b5cf6', ledIdle:'#c4b5fd', ledGlow:'rgba(139,92,246,0.15)', ledGlowIdle:'rgba(139,92,246,0.06)',
    border:'rgba(168,85,247,'},
  dark: {bg:'#1e1528', wallTop:'#271c35', wallBot:'#1e1528', glow:'rgba(139,92,246,0.2)', glowIdle:'rgba(139,92,246,0.08)',
    badge:'#2d1f42', badgeText:'#c4b5fd', table:'#2d1f42', tableStroke:'rgba(139,92,246,0.3)',
    projBg:'#251a38', projIdle:'#1e1528', projStroke:'rgba(139,92,246,0.25)',
    barColors:['#4c1d95','#5b21b6','#6d28d9','#7c3aed','#8b5cf6','#7c3aed','#6d28d9','#5b21b6'],
    ledActive:'#a78bfa', ledIdle:'#6d28d9', ledGlow:'rgba(139,92,246,0.25)', ledGlowIdle:'rgba(139,92,246,0.1)',
    border:'rgba(168,85,247,'},
};

const SERVER_THEME = {
  light: {bg:'#f0fdfa', wallTop:'#ccfbf1', wallBot:'#f0fdfa', glow:'rgba(20,184,166,0.08)',
    badge:'#ccfbf1', badgeText:'#0f766e', rackBg:'#e6fffa', rackStroke:'rgba(20,184,166,0.2)',
    barActive:'rgba(20,184,166,0.5)', barMid:'rgba(20,184,166,0.3)', barOff:'rgba(0,0,0,0.04)',
    ledOn:'#14b8a6', ledOff:'rgba(20,184,166,0.15)', ledGlow:'rgba(20,184,166,0.15)',
    mainLedGlow:'rgba(20,184,166,0.1)', mainLed:'#14b8a6', border:'rgba(20,184,166,'},
  dark: {bg:'#0f1f1d', wallTop:'#14302b', wallBot:'#0f1f1d', glow:'rgba(20,184,166,0.15)',
    badge:'#14302b', badgeText:'#5eead4', rackBg:'#132e28', rackStroke:'rgba(20,184,166,0.3)',
    barActive:'rgba(20,184,166,0.6)', barMid:'rgba(20,184,166,0.4)', barOff:'rgba(255,255,255,0.04)',
    ledOn:'#2dd4bf', ledOff:'rgba(20,184,166,0.25)', ledGlow:'rgba(20,184,166,0.25)',
    mainLedGlow:'rgba(20,184,166,0.2)', mainLed:'#2dd4bf', border:'rgba(20,184,166,'},
};

function getStatusThemes() { return isDarkMode() ? STATUS_THEMES_DARK : STATUS_THEMES; }
function getAgentPalette(id) { return isDarkMode() ? (PALETTES_DARK[id]||PALETTES_DARK.raven) : (PALETTES[id]||PALETTES.raven); }
function getCanvasBg() { return isDarkMode() ? '#1c1c1e' : '#f5f5f7'; }
function getMeetingTheme() { return isDarkMode() ? MEETING_THEME.dark : MEETING_THEME.light; }
function getServerTheme() { return isDarkMode() ? SERVER_THEME.dark : SERVER_THEME.light; }

const FRAMES = [
  [[0,1,1,1,0],[1,2,1,2,1],[0,1,1,1,0],[1,3,3,3,1],[0,3,3,3,0],[0,1,0,1,0],[1,0,0,0,1]],
  [[0,1,1,1,0],[1,2,1,2,1],[0,1,1,1,0],[1,3,3,3,1],[0,3,3,3,0],[1,0,1,0,1],[0,1,0,1,0]],
];

let agentMap = {};
let selectedId = null;
let curTab = 'overview';
let detailCache = null;
let drawerOpen = false;
let availableModels = [];

const PLATFORM_ICONS = { telegram:'\u2708\uFE0F', discord:'\uD83D\uDCAC', whatsapp:'\uD83D\uDCF1' };
const PLATFORM_LABELS = { telegram:'Telegram', discord:'Discord', whatsapp:'WhatsApp' };
let availablePlatforms = ['telegram','discord','whatsapp'];

function platformBadgeHtml(p) {
  const label = PLATFORM_LABELS[p] || 'No Platform';
  const icon = PLATFORM_ICONS[p] || '';
  return `<span class="platform-badge ${esc(p||'none')}">${icon} ${esc(label)}</span>`;
}

async function fetchAvailablePlatforms() {
  try { availablePlatforms = await (await fetch('/api/platforms')).json(); } catch(e) {}
}

/* Clock */
function updateClock() {
  document.getElementById('live-clock').textContent =
    new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateClock, 1000); updateClock();

/* Fetch available models */
async function fetchAvailableModels() {
  try {
    availableModels = await (await fetch('/api/models/available')).json();
    const dl = document.getElementById('all-models-datalist');
    if (dl) dl.innerHTML = availableModels.map(m => `<option value="${m}">`).join('');
  } catch(e) {}
}

/* OfficeMap — integrated particles + rooms */
class OfficeMap {
  constructor(canvas) {
    this.canvas = canvas; this.ctx = canvas.getContext('2d');
    this.sprites = {}; this.tick = 0;
    this.particles = [];
    this.hoveredCell = null;
    this._resize();
    // Spawn particles AFTER resize so they spread across full canvas
    for (let i = 0; i < 70; i++) this.particles.push(this._spawnParticle());
    window.addEventListener('resize', () => this._resize());
    canvas.addEventListener('click', e => this._onClick(e));
    canvas.addEventListener('mousemove', e => this._onHover(e));
    canvas.addEventListener('mouseleave', () => { this.hoveredCell = null; });
    this._loop();
  }
  _spawnParticle() {
    const colors = ['0,122,255','52,199,89','175,82,222','255,149,0','88,86,214','255,45,85','236,72,153','20,184,166'];
    return { x:Math.random()*this.canvas.width, y:Math.random()*this.canvas.height,
      vx:(Math.random()-0.5)*0.9, vy:(Math.random()-0.5)*0.7,
      r:Math.random()*3+1.8, a:Math.random()*0.30+0.15,
      color: colors[Math.floor(Math.random()*colors.length)] };
  }
  _resize() {
    const a = this.canvas.parentElement;
    this.canvas.width = a.clientWidth; this.canvas.height = a.clientHeight;
    this.CW = a.clientWidth/3; this.CH = a.clientHeight/3;
    this.S = Math.max(2, Math.floor(Math.min(this.CW, this.CH)/45));
    Object.values(this.sprites).forEach(sp => { if (sp.tx!==undefined){sp.x=sp.tx;sp.y=sp.ty;} });
    // Redistribute particles across new canvas size
    this.particles.forEach(p => {
      p.x = Math.random()*this.canvas.width;
      p.y = Math.random()*this.canvas.height;
    });
  }
  _cellO(c,r) { return {x:c*this.CW, y:r*this.CH}; }
  _home(id) {
    const c = AGENT_CELLS[id]; if (!c) return null;
    const o = this._cellO(c.col,c.row);
    return {x:o.x+this.CW*0.55, y:o.y+this.CH*0.75};
  }
  _cellAt(px, py) {
    const col = Math.floor(px / this.CW), row = Math.floor(py / this.CH);
    if (col < 0 || col > 2 || row < 0 || row > 2) return null;
    return {col, row};
  }
  _onClick(e) {
    const rect = this.canvas.getBoundingClientRect();
    const cell = this._cellAt(e.clientX - rect.left, e.clientY - rect.top);
    if (!cell) return;
    const id = Object.keys(AGENT_CELLS).find(k => AGENT_CELLS[k].col===cell.col && AGENT_CELLS[k].row===cell.row);
    if (id) selectAgent(id);
  }
  _onHover(e) {
    const rect = this.canvas.getBoundingClientRect();
    this.hoveredCell = this._cellAt(e.clientX - rect.left, e.clientY - rect.top);
  }
  update(agents) {
    agents.forEach(a => {
      if (!this.sprites[a.id]) { const h=this._home(a.id)||{x:0,y:0}; this.sprites[a.id]={x:h.x,y:h.y,dir:1}; }
      else { const h=this._home(a.id); if(h){this.sprites[a.id].x=h.x;this.sprites[a.id].y=h.y;} }
    });
  }
  _loop() { const f=()=>{this.tick++;this._render();requestAnimationFrame(f);}; requestAnimationFrame(f); }

  _render() {
    const {ctx, CW, CH, canvas} = this;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Background
    ctx.fillStyle = getCanvasBg();
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 1. Draw rooms first
    for (let r=0;r<3;r++) for (let c=0;c<3;c++) {
      if (c===1&&r===1) { this._drawMeeting(c,r); continue; }
      if (c===2&&r===2) { this._drawServer(c,r); continue; }
      const id = Object.keys(AGENT_CELLS).find(k=>AGENT_CELLS[k].col===c&&AGENT_CELLS[k].row===r);
      if (id) this._drawRoom(c,r,id);
    }

    // 2. Draw particles ON TOP of rooms
    this.particles.forEach(p => {
      p.x += p.vx; p.y += p.vy;
      if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
      // Outer glow
      const grd = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*5);
      grd.addColorStop(0, `rgba(${p.color},${p.a*0.5})`);
      grd.addColorStop(0.5, `rgba(${p.color},${p.a*0.15})`);
      grd.addColorStop(1, `rgba(${p.color},0)`);
      ctx.fillStyle = grd;
      ctx.fillRect(p.x-p.r*5,p.y-p.r*5,p.r*10,p.r*10);
      // Core
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(${p.color},${p.a+0.15})`; ctx.fill();
      // Bright center
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r*0.4, 0, Math.PI*2);
      ctx.fillStyle = `rgba(255,255,255,${p.a*0.6})`; ctx.fill();
    });
    // Connection lines
    for (let i=0; i<this.particles.length; i++)
      for (let j=i+1; j<this.particles.length; j++) {
        const dx=this.particles[i].x-this.particles[j].x, dy=this.particles[i].y-this.particles[j].y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if (dist<180) {
          const fade = 1-dist/180;
          ctx.beginPath(); ctx.moveTo(this.particles[i].x,this.particles[i].y); ctx.lineTo(this.particles[j].x,this.particles[j].y);
          ctx.strokeStyle=`rgba(${this.particles[i].color},${0.22*fade})`; ctx.lineWidth=1.2*fade+0.4; ctx.stroke();
        }
      }

    // 3. Draw characters on top of everything
    Object.entries(this.sprites).forEach(([id,sp]) => {
      const status = (agentMap[id]||{}).status||'offline';
      const bobY = Math.sin(this.tick*(status==='busy'?0.12:status==='idle'?0.06:0.03))*(status==='busy'?4:status==='idle'?2.5:1.5);
      const bobX = status==='busy' ? Math.sin(this.tick*0.07+0.5)*2 : 0;
      const frame = status==='busy' ? (Math.floor(this.tick/15)%2) : 0;
      this._drawChar(sp.x+bobX, sp.y+bobY, id, status, sp.dir, frame);
    });
  }

  _drawRoom(col, row, id) {
    const {ctx, CW:W, CH:H, tick, S} = this;
    const {x, y} = this._cellO(col, row);
    const a = agentMap[id]||{};
    const th = getStatusThemes()[a.status||'offline'];
    const pal = getAgentPalette(id);
    const gap = 4;

    // Room card with rounded corners
    ctx.save();
    this._roundRect(ctx, x+gap, y+gap, W-gap*2, H-gap*2, 16);
    ctx.clip();

    // Floor
    ctx.fillStyle = th.floor; ctx.fillRect(x, y, W, H);

    // Wall (top 35%)
    const wallH = H*0.35;
    const wg = ctx.createLinearGradient(x,y,x,y+wallH);
    wg.addColorStop(0, th.wallTop); wg.addColorStop(1, th.wall);
    ctx.fillStyle = wg; ctx.fillRect(x, y, W, wallH);

    // Room glow — always visible, stronger for busy
    const glowAlpha = a.status==='busy' ? 0.18 : a.status==='idle' ? 0.08 : a.status==='inactive' ? 0.06 : 0.02;
    const glowPulse = 1 + 0.3 * Math.sin(tick * 0.03);
    const glow = ctx.createRadialGradient(x+W/2,y+H/2,0,x+W/2,y+H/2,W*0.55*glowPulse);
    glow.addColorStop(0, th.accent+(Math.round(glowAlpha*255).toString(16).padStart(2,'0')));
    glow.addColorStop(1,'transparent');
    ctx.fillStyle = glow; ctx.fillRect(x,y,W,H);

    ctx.restore();

    // Hover highlight
    const isHovered = this.hoveredCell && this.hoveredCell.col===col && this.hoveredCell.row===row;
    if (isHovered) {
      ctx.save();
      this._roundRect(ctx, x+gap, y+gap, W-gap*2, H-gap*2, 16);
      ctx.shadowColor = pal.body; ctx.shadowBlur = 20;
      ctx.strokeStyle = pal.accent; ctx.lineWidth = 2.5; ctx.stroke();
      ctx.restore();
    }

    // Border — breathing animation (more pronounced)
    const breathe = 0.4 + 0.6 * Math.sin(tick * 0.035);
    ctx.strokeStyle = isHovered ? pal.accent : th.accent+(Math.round((0.15+breathe*0.25)*255).toString(16).padStart(2,'0'));
    ctx.lineWidth = isHovered ? 2.5 : 0.8 + breathe * 1.2;
    this._roundRect(ctx, x+gap, y+gap, W-gap*2, H-gap*2, 16); ctx.stroke();

    // Name badge
    const badgeW = Math.min(W*0.5, 100), badgeH = 24;
    const badgeX = x+(W-badgeW)/2, badgeY = y+gap+8;
    ctx.fillStyle = pal.bg+'dd';
    this._roundRect(ctx, badgeX, badgeY, badgeW, badgeH, 8); ctx.fill();
    ctx.strokeStyle = pal.accent+'66'; ctx.lineWidth = 0.5;
    this._roundRect(ctx, badgeX, badgeY, badgeW, badgeH, 8); ctx.stroke();

    ctx.fillStyle = pal.dark;
    ctx.font = `700 ${Math.max(11,S+4)}px Inter,-apple-system,sans-serif`;
    ctx.textBaseline='middle'; ctx.textAlign='center';
    ctx.fillText(id.toUpperCase(), x+W/2, badgeY+badgeH/2);
    ctx.textAlign='left';

    // Model
    const mdl = (a.model||'').split('/').pop().substring(0,16);
    if (mdl) {
      ctx.fillStyle = th.text+'88';
      ctx.font = `500 ${Math.max(9,S+2)}px Inter,-apple-system,sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.fillText(mdl, x+W/2, badgeY+badgeH+3);
      ctx.textAlign='left';
    }

    // Task board
    if (a.currentTask) {
      const bx=x+gap+10, by=y+wallH+8, bw=W-gap*2-20, bh=H*0.15;
      ctx.fillStyle = isDarkMode() ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.8)';
      this._roundRect(ctx, bx, by, bw, bh, 6); ctx.fill();
      ctx.strokeStyle = isDarkMode() ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)'; ctx.lineWidth = 0.5;
      this._roundRect(ctx, bx, by, bw, bh, 6); ctx.stroke();
      ctx.fillStyle = th.label; ctx.font = `500 ${Math.max(9,S+2)}px Inter,-apple-system,sans-serif`;
      ctx.textBaseline='top';
      this._wrap(ctx, a.currentTask, bx+6, by+4, bw-12, Math.max(10,S+3), 2);
    }

    // Desk
    const dw=W*0.36, dh=H*0.09, dx2=x+W*0.08, dy2=y+H*0.63;
    ctx.fillStyle = isDarkMode() ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)';
    this._roundRect(ctx, dx2, dy2, dw, dh, 4); ctx.fill();

    // Monitor
    const mw=dw*0.45, mh=dh*1.2, mx=dx2+(dw-mw)/2, my=dy2-mh-2;
    ctx.fillStyle = a.status==='busy' ? pal.bg : a.status==='idle' ? pal.bgSolid : isDarkMode() ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
    this._roundRect(ctx, mx, my, mw, mh, 3); ctx.fill();
    // Screen flicker for busy
    if (a.status==='busy') {
      const flicker = 0.15+0.1*Math.sin(tick*0.2);
      ctx.fillStyle = `rgba(255,255,255,${flicker})`;
      this._roundRect(ctx, mx+1, my+1, mw-2, mh-2, 2); ctx.fill();
    }
    ctx.strokeStyle = a.status==='busy' ? pal.accent+'66' : isDarkMode() ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'; ctx.lineWidth=0.5;
    this._roundRect(ctx, mx, my, mw, mh, 3); ctx.stroke();
    // Screen glow
    if (a.status==='busy') {
      ctx.beginPath(); ctx.arc(mx+mw/2,my+mh/2,mw*0.8,0,Math.PI*2);
      ctx.fillStyle = pal.accent+'15'; ctx.fill();
    }
    // Stand
    ctx.fillStyle = isDarkMode() ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
    ctx.fillRect(mx+mw/2-2, my+mh, 4, 4);

    // LED — always animated with ring pulse
    const lx=x+W-gap-14, ly=y+gap+14;
    const pulse = a.status==='busy' ? 0.6+0.4*Math.sin(tick*0.1) : a.status==='idle' ? 0.8+0.2*Math.sin(tick*0.05) : 1;
    // Outer ring pulse
    const ringR = a.status==='busy' ? 10+4*Math.sin(tick*0.06) : a.status==='idle' ? 8+2*Math.sin(tick*0.03) : 6;
    const ringA = a.status==='busy' ? 0.2+0.1*Math.sin(tick*0.08) : a.status==='idle' ? 0.1 : 0.04;
    ctx.beginPath(); ctx.arc(lx,ly,ringR,0,Math.PI*2);
    ctx.fillStyle = th.accent+(Math.round(ringA*255).toString(16).padStart(2,'0')); ctx.fill();
    // Inner dot
    ctx.beginPath(); ctx.arc(lx,ly,4.5*pulse,0,Math.PI*2);
    ctx.fillStyle = th.accent; ctx.fill();
    // Bright center
    ctx.beginPath(); ctx.arc(lx,ly,2*pulse,0,Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.fill();
  }

  _drawMeeting(col, row) {
    const {ctx, CW:W, CH:H, tick} = this;
    const {x, y} = this._cellO(col, row);
    const gap = 4;
    const busyN = Object.values(agentMap).filter(a=>a.status==='busy').length;
    const mt = getMeetingTheme();

    ctx.save();
    this._roundRect(ctx, x+gap, y+gap, W-gap*2, H-gap*2, 16); ctx.clip();
    ctx.fillStyle = mt.bg; ctx.fillRect(x,y,W,H);
    const wg = ctx.createLinearGradient(x,y,x,y+H*0.32);
    wg.addColorStop(0, mt.wallTop); wg.addColorStop(1, mt.wallBot);
    ctx.fillStyle = wg; ctx.fillRect(x,y,W,H*0.32);
    // Ambient glow
    const mg = ctx.createRadialGradient(x+W/2,y+H/2,0,x+W/2,y+H/2,W*0.5);
    mg.addColorStop(0, busyN>0 ? mt.glow : mt.glowIdle);
    mg.addColorStop(1,'transparent');
    ctx.fillStyle = mg; ctx.fillRect(x,y,W,H);
    ctx.restore();

    // Breathing border
    const mb = 0.15 + 0.15*Math.sin(tick*0.03);
    ctx.strokeStyle = mt.border+mb+')'; ctx.lineWidth=1+0.5*Math.sin(tick*0.03);
    this._roundRect(ctx, x+gap, y+gap, W-gap*2, H-gap*2, 16); ctx.stroke();

    // Badge
    const bw=90, bx=x+(W-bw)/2;
    ctx.fillStyle = mt.badge;
    this._roundRect(ctx, bx, y+gap+8, bw, 22, 8); ctx.fill();
    ctx.fillStyle = mt.badgeText;
    ctx.font = `700 ${Math.max(11,this.S+4)}px Inter,-apple-system,sans-serif`;
    ctx.textBaseline='middle'; ctx.textAlign='center';
    ctx.fillText('MEETING', x+W/2, y+gap+19); ctx.textAlign='left';

    // Table with shimmer
    const tw=W*0.45, th2=H*0.22, tx=x+(W-tw)/2, ty=y+H*0.42;
    ctx.fillStyle = mt.table;
    this._roundRect(ctx, tx, ty, tw, th2, 10); ctx.fill();
    // Table shimmer
    const shimX = tx + (tick*0.8 % (tw+40)) - 20;
    ctx.save(); this._roundRect(ctx, tx, ty, tw, th2, 10); ctx.clip();
    const shim = ctx.createLinearGradient(shimX-15,0,shimX+15,0);
    shim.addColorStop(0,'transparent'); shim.addColorStop(0.5, isDarkMode()?'rgba(255,255,255,0.15)':'rgba(255,255,255,0.4)'); shim.addColorStop(1,'transparent');
    ctx.fillStyle = shim; ctx.fillRect(tx,ty,tw,th2);
    ctx.restore();
    ctx.strokeStyle = mt.tableStroke; ctx.lineWidth=0.5;
    this._roundRect(ctx, tx, ty, tw, th2, 10); ctx.stroke();

    // Projector — always show, more animated when busy
    const sx=x+W*0.15, sy=y+H*0.06, sw=W*0.7, sh=H*0.22;
    ctx.fillStyle = busyN>0 ? mt.projBg : mt.projIdle;
    this._roundRect(ctx, sx, sy, sw, sh, 8); ctx.fill();
    ctx.strokeStyle = mt.projStroke; ctx.lineWidth=0.5;
    this._roundRect(ctx, sx, sy, sw, sh, 8); ctx.stroke();
    const bars=8, barW=(sw-14)/bars;
    for (let i=0;i<bars;i++) {
      const speed = busyN>0 ? 0.06 : 0.02;
      const bh=sh*0.6*(0.2+0.8*Math.abs(Math.sin(tick*speed+i*0.7)));
      ctx.fillStyle=mt.barColors[i];
      this._roundRect(ctx, sx+7+i*barW, sy+sh-bh-4, barW-2, bh, 3); ctx.fill();
    }

    // LED with ring
    const lx2=x+W-gap-14, ly2=y+gap+14;
    const p2=busyN>0?0.7+0.3*Math.sin(tick*0.1):0.85+0.15*Math.sin(tick*0.04);
    ctx.beginPath(); ctx.arc(lx2,ly2,8+2*Math.sin(tick*0.05),0,Math.PI*2);
    ctx.fillStyle = busyN>0 ? mt.ledGlow : mt.ledGlowIdle; ctx.fill();
    ctx.beginPath(); ctx.arc(lx2,ly2,4.5*p2,0,Math.PI*2);
    ctx.fillStyle = busyN>0 ? mt.ledActive : mt.ledIdle; ctx.fill();
    ctx.beginPath(); ctx.arc(lx2,ly2,2*p2,0,Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fill();
  }

  _drawServer(col, row) {
    const {ctx, CW:W, CH:H, tick} = this;
    const {x, y} = this._cellO(col, row);
    const gap = 4;
    const st = getServerTheme();

    ctx.save();
    this._roundRect(ctx, x+gap, y+gap, W-gap*2, H-gap*2, 16); ctx.clip();
    ctx.fillStyle = st.bg; ctx.fillRect(x,y,W,H);
    const wg = ctx.createLinearGradient(x,y,x,y+H*0.3);
    wg.addColorStop(0, st.wallTop); wg.addColorStop(1, st.wallBot);
    ctx.fillStyle = wg; ctx.fillRect(x,y,W,H*0.3);
    // Ambient glow
    const sg = ctx.createRadialGradient(x+W/2,y+H/2,0,x+W/2,y+H/2,W*0.5);
    sg.addColorStop(0, st.glow); sg.addColorStop(1,'transparent');
    ctx.fillStyle = sg; ctx.fillRect(x,y,W,H);
    ctx.restore();

    // Breathing border
    const sb = 0.12 + 0.12*Math.sin(tick*0.025);
    ctx.strokeStyle = st.border+sb+')'; ctx.lineWidth=1+0.4*Math.sin(tick*0.025);
    this._roundRect(ctx, x+gap, y+gap, W-gap*2, H-gap*2, 16); ctx.stroke();

    // Badge
    const bw=90, bx=x+(W-bw)/2;
    ctx.fillStyle = st.badge;
    this._roundRect(ctx, bx, y+gap+8, bw, 22, 8); ctx.fill();
    ctx.fillStyle = st.badgeText;
    ctx.font = `700 ${Math.max(11,this.S+4)}px Inter,-apple-system,sans-serif`;
    ctx.textBaseline='middle'; ctx.textAlign='center';
    ctx.fillText('SERVERS', x+W/2, y+gap+19); ctx.textAlign='left';

    // Racks — more vibrant
    const ncols=3, rw=W*0.18, rh=H*0.45;
    const sx=x+(W-ncols*(rw+8))/2, sy=y+H*0.38;
    for (let c=0;c<ncols;c++) {
      const rx=sx+c*(rw+8);
      ctx.fillStyle = st.rackBg;
      this._roundRect(ctx, rx, sy, rw, rh, 6); ctx.fill();
      ctx.strokeStyle = st.rackStroke; ctx.lineWidth=0.5;
      this._roundRect(ctx, rx, sy, rw, rh, 6); ctx.stroke();
      for (let r=0;r<6;r++) {
        const ly=sy+5+r*(rh/6);
        const phase = (tick*0.8+c*7+r*4)%40;
        const on = phase<30;
        // Data bar with gradient
        if (on) {
          const barFill = 0.3+0.5*Math.abs(Math.sin(tick*0.03+c*2+r));
          const bg = ctx.createLinearGradient(rx+3,0,rx+rw-3,0);
          bg.addColorStop(0, st.barActive);
          bg.addColorStop(barFill, st.barMid);
          bg.addColorStop(barFill, st.barOff);
          bg.addColorStop(1, st.barOff);
          ctx.fillStyle = bg;
        } else {
          ctx.fillStyle = st.barOff;
        }
        this._roundRect(ctx, rx+3, ly, rw-6, 3.5, 1.5); ctx.fill();
        // LED dot
        const ledOn = on && phase<25;
        ctx.beginPath(); ctx.arc(rx+rw-5,ly+1.75,2,0,Math.PI*2);
        ctx.fillStyle = ledOn ? st.ledOn : st.ledOff; ctx.fill();
        if (ledOn) { ctx.beginPath(); ctx.arc(rx+rw-5,ly+1.75,4,0,Math.PI*2); ctx.fillStyle=st.ledGlow; ctx.fill(); }
      }
    }

    // Server LED
    const slx=x+W-gap-14, sly=y+gap+14;
    const sp=0.8+0.2*Math.sin(tick*0.06);
    ctx.beginPath(); ctx.arc(slx,sly,8+Math.sin(tick*0.04)*2,0,Math.PI*2);
    ctx.fillStyle = st.mainLedGlow; ctx.fill();
    ctx.beginPath(); ctx.arc(slx,sly,4.5*sp,0,Math.PI*2);
    ctx.fillStyle = st.mainLed; ctx.fill();
    ctx.beginPath(); ctx.arc(slx,sly,2*sp,0,Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fill();
  }

  _drawChar(cx, cy, id, status, dir, frameIdx=0) {
    const {ctx, S, tick} = this;
    const pal = getAgentPalette(id);
    const frame = FRAMES[frameIdx%FRAMES.length];
    const alpha = status==='offline'?0.25:status==='inactive'?0.55:1;
    const PW=5*S, PH=7*S, px=cx-PW/2, py=cy-PH;
    const dk = isDarkMode();

    ctx.save(); ctx.globalAlpha=alpha;
    if (dir===-1) { ctx.translate(px*2+PW,0); ctx.scale(-1,1); }

    // Shadow
    ctx.beginPath(); ctx.ellipse(cx,cy+2,PW*0.35,S*0.6,0,0,Math.PI*2);
    ctx.fillStyle = dk ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.08)'; ctx.fill();

    // Pixels
    for (let r=0;r<frame.length;r++) for (let c=0;c<frame[r].length;c++) {
      if (frame[r][c]) { ctx.fillStyle = dk ? 'rgba(0,0,0,0.2)' : 'rgba(0,0,0,0.06)'; ctx.fillRect(px+c*S+0.5,py+r*S+0.5,S,S); }
    }
    for (let r=0;r<frame.length;r++) for (let c=0;c<frame[r].length;c++) {
      const p=frame[r][c]; if(!p) continue;
      ctx.fillStyle = p===2?pal.eye:p===3?pal.shirt:pal.body;
      ctx.fillRect(px+c*S,py+r*S,S,S);
    }

    // Busy dots — bouncing thought bubbles
    if (status==='busy') for (let i=0;i<3;i++) {
      const bounce = Math.abs(Math.sin(tick*0.15+i*1.8))*S*1.2;
      const dotR = S*0.4 + Math.sin(tick*0.1+i)*S*0.1;
      ctx.fillStyle = pal.accent;
      ctx.beginPath(); ctx.arc(px+(1+i)*S+S/2, py-S*1.5-bounce, dotR, 0, Math.PI*2); ctx.fill();
      // Dot glow
      ctx.beginPath(); ctx.arc(px+(1+i)*S+S/2, py-S*1.5-bounce, dotR*2.5, 0, Math.PI*2);
      ctx.fillStyle = pal.accent+'22'; ctx.fill();
    }
    // Idle sparkle
    if (status==='idle' && tick%40<8) {
      const sx=cx+S*2, sy=cy-PH-S;
      const sp=Math.sin(tick*0.3)*S*0.4+S*0.5;
      ctx.strokeStyle=pal.accent+'88'; ctx.lineWidth=1.2;
      ctx.beginPath(); ctx.moveTo(sx,sy-sp); ctx.lineTo(sx,sy+sp); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(sx-sp,sy); ctx.lineTo(sx+sp,sy); ctx.stroke();
    }

    // Name
    ctx.fillStyle = pal.dark+(alpha<1?'88':'cc');
    ctx.font = `600 ${Math.max(9,S+2)}px Inter,-apple-system,sans-serif`;
    ctx.textAlign='center'; ctx.textBaseline='top';
    ctx.fillText(id, cx, cy+4);
    ctx.textAlign='left';
    ctx.restore();
  }

  _roundRect(ctx,x,y,w,h,r) {
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r);
    ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r);
    ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
  }
  _wrap(ctx,text,x,y,mw,lh,maxL) {
    const words=text.split(/\s+/); let line='',drawn=0;
    for (const w of words) { if(drawn>=maxL)break; const t=line?line+' '+w:w;
      if(ctx.measureText(t).width>mw&&line){ctx.fillText(line,x,y+drawn*lh);drawn++;line=w;}else line=t; }
    if(drawn<maxL&&line)ctx.fillText(line,x,y+drawn*lh);
  }
}

/* STATUS */
function calcStatus(lastActivity) {
  if (!lastActivity) return 'offline';
  const diff = (Date.now()-new Date(lastActivity).getTime())/1000;
  if (diff<120) return 'busy'; if (diff<600) return 'idle';
  if (diff<3600) return 'inactive'; return 'offline';
}

/* SIDEBAR */
function renderSidebar(agents) {
  const list = document.getElementById('agent-list');
  list.innerHTML = '';
  let counts={busy:0,idle:0,inactive:0,offline:0}, totalSessions=0;
  agents.forEach(a=>{ counts[a.status||'offline']++; totalSessions+=(a.activeSessions||0); });

  document.getElementById('agent-count').textContent = agents.length;
  document.getElementById('ss-busy').textContent = counts.busy;
  document.getElementById('ss-idle').textContent = counts.idle;
  document.getElementById('ss-inact').textContent = counts.inactive;
  document.getElementById('ss-off').textContent = counts.offline;
  document.getElementById('kpi-active').textContent = counts.busy+counts.idle;
  document.getElementById('kpi-sessions').textContent = totalSessions;
  // fs-active and fs-sessions are set via animateCounter in fetchAgents
  document.getElementById('fs-total').textContent = agents.length;
  const pct = agents.length?Math.round((counts.busy+counts.idle)/agents.length*100):0;
  document.getElementById('fs-active-bar').style.width = pct+'%';
  document.getElementById('fs-sess-bar').style.width = Math.min(100,totalSessions*5)+'%';

  agents.forEach(a => {
    const st=a.status||'offline', pal=PALETTES[a.id]||PALETTES.raven;
    const task=a.currentTask?a.currentTask.replace(/\n/g,' ').substring(0,50):'';
    const div=document.createElement('div');
    div.className='agent-item'+(a.id===selectedId?' sel':'');
    div.onclick=()=>selectAgent(a.id);
    div.innerHTML=`
      <div class="agent-avatar" style="background:linear-gradient(135deg,${pal.body},${pal.shirt})">
        ${a.id.substring(0,2).toUpperCase()}
        <div class="av-status ${st}"></div>
      </div>
      <div class="agent-info">
        <div class="ai-name">${a.name}</div>
        ${task?`<div class="ai-task">${esc(task)}</div>`:`<div class="ai-task" style="font-style:italic">${st}</div>`}
        <div class="ai-meta">${platformBadgeHtml(a.platform)}<span class="ai-sessions">${a.activeSessions} sessions</span></div>
      </div>`;
    list.appendChild(div);
  });
}

/* DETAIL PANEL */
async function selectAgent(id) {
  selectedId=id; curTab='overview';
  document.querySelectorAll('.dtab').forEach((el,i)=>el.classList.toggle('act',i===0));
  document.getElementById('detail-panel').classList.add('open');
  document.getElementById('overlay').classList.add('show');

  const pal=PALETTES[id]||PALETTES.raven, a=agentMap[id]||{};
  document.getElementById('dp-avatar-lg').style.background=`linear-gradient(135deg,${pal.body},${pal.shirt})`;
  document.getElementById('dp-avatar-lg').textContent=id.substring(0,2).toUpperCase();
  document.getElementById('dp-name').textContent=(a.name||id);
  document.getElementById('dp-model').textContent=a.model||'';

  const sb=document.getElementById('dp-status-badge'), st=a.status||'offline';
  const dk=isDarkMode();
  sb.textContent=st;
  sb.style.background = st==='busy'?(dk?'rgba(10,132,255,0.15)':'rgba(0,122,255,0.08)'):st==='idle'?(dk?'rgba(48,209,88,0.15)':'rgba(52,199,89,0.08)'):st==='inactive'?(dk?'rgba(255,159,10,0.15)':'rgba(255,149,0,0.08)'):(dk?'rgba(255,255,255,0.05)':'rgba(0,0,0,0.04)');
  sb.style.color = st==='busy'?'var(--blue)':st==='idle'?'var(--green)':st==='inactive'?'var(--orange)':'var(--text-tertiary)';

  document.getElementById('task-ok').style.display='none';
  document.getElementById('task-err').style.display='none';
  document.getElementById('task-input').value='';
  document.getElementById('dp-body').innerHTML='<div style="color:var(--text-tertiary);font-size:12px;padding:20px;text-align:center">Loading...</div>';
  renderSidebar(Object.values(agentMap));

  try {
    const r=await fetch(`/api/agent/${id}`);
    detailCache=await r.json();
    document.getElementById('dp-model').textContent=detailCache.model||'';
    renderDetail();
  } catch(e) {
    document.getElementById('dp-body').innerHTML='<div style="color:var(--red);font-size:12px;padding:20px;text-align:center">Failed to load.</div>';
  }
}

function closeDetail() {
  selectedId=null; detailCache=null;
  document.getElementById('detail-panel').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
  renderSidebar(Object.values(agentMap));
}

function switchTab(tab) {
  curTab=tab;
  const tabs=['overview','messages','profile','task'];
  document.querySelectorAll('.dtab').forEach((el,i)=>el.classList.toggle('act',tabs[i]===tab));
  document.getElementById('task-form').style.display=tab==='task'?'block':'none';
  if (tab==='profile' && selectedId) loadProfile(selectedId);
  else renderDetail();
}

function renderDetail() {
  if (!detailCache) return;
  const body=document.getElementById('dp-body'), d=detailCache, a=agentMap[selectedId]||{};

  if (curTab==='overview') {
    const tok=d.tokens||{};
    const pct=tok.context?Math.min(100,Math.round((tok.total||0)/tok.context*100)):0;
    const barClass=pct>80?'high':pct>50?'mid':'low';
    const stColor=a.status==='busy'?'var(--blue)':a.status==='idle'?'var(--green)':a.status==='inactive'?'var(--orange)':'var(--text-tertiary)';
    body.innerHTML=`
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">
        <div class="stat-card"><div class="sc-label">Status</div><div class="sc-value" style="color:${stColor};font-size:16px">${(a.status||'unknown').toUpperCase()}</div></div>
        <div class="stat-card"><div class="sc-label">Sessions</div><div class="sc-value">${d.sessionCount}</div></div>
      </div>
      <div class="sec" style="margin-top:0">Context Usage</div>
      <div class="tbar-wrap">
        <div class="tbar-lbl"><span>${pct}% used</span><span style="color:var(--text);font-weight:600">${(tok.total||0).toLocaleString()} / ${(tok.context||0).toLocaleString()}</span></div>
        <div class="tbar"><div class="tbar-fill ${barClass}" style="width:${pct}%"></div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">
        <div class="info-row"><span>Input</span><span class="v">${(tok.input||0).toLocaleString()}</span></div>
        <div class="info-row"><span>Output</span><span class="v">${(tok.output||0).toLocaleString()}</span></div>
      </div>
      <div class="sec">Last Activity</div>
      <div class="info-row"><span>Time</span><span class="v">${a.lastActivity?new Date(a.lastActivity).toLocaleTimeString():'--'}</span></div>
      <div class="sec">Model</div>
      <select class="model-select" id="model-selector" onchange="changeModel(this.value)">
        <option value="">${a.model||'(default)'}</option>
        ${availableModels.map(m=>`<option value="${esc(m)}" ${m===(a.model||'')?'selected':''}>${esc(m)}</option>`).join('')}
      </select>
      <div class="model-status" id="model-status"></div>

      <div class="sec">Platform</div>
      <select class="model-select" id="platform-selector" onchange="changePlatform(this.value)">
        ${availablePlatforms.map(p => `<option value="${esc(p)}" ${p===(d.platform||'')?'selected':''}>${PLATFORM_LABELS[p]||p}</option>`).join('')}
      </select>
      <div class="model-status" id="platform-status"></div>

      <div class="sec">Current Task</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;background:${isDarkMode()?'rgba(255,255,255,0.03)':'rgba(0,0,0,0.02)'};padding:12px;border-radius:var(--radius-xs);word-break:break-word">
        ${a.currentTask?esc(a.currentTask):'<em style="color:var(--text-tertiary)">No active task</em>'}
      </div>`;
  } else if (curTab==='messages') {
    const msgs=(d.messages||[]).slice(-20);
    if (!msgs.length) { body.innerHTML='<div style="color:var(--text-tertiary);font-size:12px;padding:20px;text-align:center">No messages.</div>'; return; }
    body.innerHTML=msgs.map(m=>`<div class="mb ${m.role}"><div>${esc(m.text)}</div><div class="mb-time">${m.role.toUpperCase()} &middot; ${m.timestamp?new Date(m.timestamp).toLocaleTimeString():''}</div></div>`).join('');
    body.scrollTop=body.scrollHeight;
  } else if (curTab==='profile') {
    body.innerHTML='<div style="color:var(--text-tertiary);font-size:12px;padding:20px;text-align:center">Loading profile...</div>';
  } else {
    body.innerHTML='<div style="font-size:12px;color:var(--text-tertiary);padding:16px;text-align:center">Type a message below to send to this agent.</div>';
  }
}

async function sendTask() {
  const msg=document.getElementById('task-input').value.trim();
  if (!msg||!selectedId) return;
  const btn=document.getElementById('btn-send'), ok=document.getElementById('task-ok'), err=document.getElementById('task-err');
  btn.disabled=true; btn.textContent='Sending...'; ok.style.display='none'; err.style.display='none';
  try {
    const r=await fetch('/api/task',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({agent_id:selectedId,message:msg})});
    const data=await r.json();
    if (data.ok) { ok.textContent='Sent. '+(data.output||'').substring(0,200); ok.style.display='block'; document.getElementById('task-input').value=''; }
    else throw new Error(data.error||'Error');
  } catch(e) { err.textContent='Failed: '+e.message; err.style.display='block'; }
  finally { btn.disabled=false; btn.textContent='Send Message'; }
}

/* MODEL CHANGE */
async function changeModel(model) {
  if (!model || !selectedId) return;
  const status = document.getElementById('model-status');
  status.textContent = 'Changing model...'; status.style.color = 'var(--text-tertiary)';
  try {
    const r = await fetch(`/api/agent/${selectedId}/model`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({model})
    });
    const data = await r.json();
    if (data.ok) {
      status.textContent = 'Model updated to ' + data.model;
      status.style.color = 'var(--green)';
      fetchAgents(); // refresh
    } else throw new Error(data.error || 'Error');
  } catch(e) {
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

/* PLATFORM CHANGE */
async function changePlatform(platform) {
  if (!platform || !selectedId) return;
  const status = document.getElementById('platform-status');
  status.textContent = 'Changing platform...'; status.style.color = 'var(--text-tertiary)';
  try {
    const r = await fetch(`/api/agent/${selectedId}/platform`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({platform})
    });
    const data = await r.json();
    if (data.ok) {
      status.textContent = 'Platform updated to ' + data.platform;
      status.style.color = 'var(--green)';
      if (agentMap[selectedId]) agentMap[selectedId].platform = data.platform;
      renderSidebar(Object.values(agentMap));
    } else throw new Error(data.error || 'Error');
  } catch(e) {
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

/* SETTINGS DRAWER */
function toggleDrawer() {
  drawerOpen=!drawerOpen;
  document.getElementById('info-drawer').classList.toggle('open',drawerOpen);
  if (drawerOpen) fetchSettings();
}

let settingsData = null;

function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type;
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => t.classList.remove('show'), 2500);
}

/* Gateway Actions */
async function gatewayAction(action) {
  const btn = document.getElementById('btn-gw-'+action);
  const prev = btn.textContent;
  btn.disabled = true; btn.textContent = '...';
  try {
    const r = await fetch('/api/gateway/'+action, {method:'POST'});
    const d = await r.json();
    showToast('Gateway '+action+' OK', 'success');
    setTimeout(fetchStatus, 2000);
  } catch(e) { showToast('Gateway '+action+' failed', 'error'); }
  finally { btn.disabled = false; btn.textContent = prev; }
}

/* Fetch all settings */
async function fetchSettings() {
  try {
    settingsData = await (await fetch('/api/settings')).json();
    renderSettingsPanel();
    fetchProviders();
    fetchBackupStatus();
  } catch(e) {}
}

let providersData = null;

async function fetchProviders() {
  try {
    providersData = await (await fetch('/api/providers')).json();
    renderProviders();
  } catch(e) {}
}

const PROVIDER_COLORS = {
  anthropic: '#d97706', openai: '#10a37f', google: '#4285f4', groq: '#f55036',
  mistral: '#ff7000', cohere: '#39594d', deepseek: '#4d6bfe', openrouter: '#6366f1',
  bedrock: '#ff9900', vertex: '#4285f4', azure: '#0078d4', ollama: '#8e8e93',
};

function getProviderColor(name) {
  const lower = name.toLowerCase();
  for (const [key, color] of Object.entries(PROVIDER_COLORS)) {
    if (lower.includes(key)) return color;
  }
  const hash = Array.from(name).reduce((h, c) => (h * 31 + c.charCodeAt(0)) & 0xffffff, 0);
  return '#' + hash.toString(16).padStart(6, '0');
}

function renderProviders() {
  const el = document.getElementById('providers-list');
  if (!providersData || !Object.keys(providersData).length) {
    el.innerHTML = '<div style="color:var(--text-tertiary);font-size:11px;padding:4px 0">No providers configured</div>';
    return;
  }

  el.innerHTML = Object.entries(providersData).map(([name, p]) => {
    const color = getProviderColor(name);
    const initials = name.substring(0, 2).toUpperCase();
    const models = (p.models || []);
    return `
    <div class="provider-card" id="provider-${esc(name)}">
      <div class="provider-header">
        <div class="provider-icon" style="background:${color}">${initials}</div>
        <span class="provider-name">${esc(name)}</span>
        <span class="provider-badge ${p.hasKey ? 'has-key' : 'no-key'}">${p.hasKey ? 'Key Set' : 'No Key'}</span>
      </div>
      <div class="provider-field">
        <span class="provider-field-label">API Key</span>
        <input class="provider-input" id="key-${esc(name)}" type="password"
          value="${p.hasKey ? p.apiKey : ''}" placeholder="Enter API key...">
        <button class="btn-icon" onclick="toggleKeyVis('${esc(name)}')" title="Show/Hide">&#x1F441;</button>
      </div>
      ${p.baseUrl ? `
      <div class="provider-field">
        <span class="provider-field-label">Base URL</span>
        <input class="provider-input" id="url-${esc(name)}" value="${esc(p.baseUrl)}" placeholder="Base URL...">
      </div>` : `
      <div class="provider-field">
        <span class="provider-field-label">Base URL</span>
        <input class="provider-input" id="url-${esc(name)}" value="" placeholder="Default (optional)">
      </div>`}
      <div class="provider-field" style="align-items:flex-start">
        <span class="provider-field-label" style="margin-top:4px">Models</span>
        <div style="flex:1">
          <div class="provider-models-list" id="models-${esc(name)}">
            ${models.map(m => `
              <span class="provider-model-tag">
                ${esc(m)}
                <span class="tag-remove" onclick="removeProviderModel('${esc(name)}','${esc(m)}')">&times;</span>
              </span>
            `).join('')}
          </div>
          <div style="display:flex;gap:4px;margin-top:6px">
            <select class="setting-select" id="add-model-${esc(name)}" style="flex:1;min-width:0;font-size:11px"
              onchange="document.getElementById('add-model-custom-${esc(name)}').style.display=this.value==='__custom__'?'block':'none'">
              <option value="">Select model...</option>
              ${availableModels.filter(m => !models.includes(m)).map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join('')}
              <option value="__custom__">Custom...</option>
            </select>
            <input class="provider-input" id="add-model-custom-${esc(name)}" placeholder="Custom model ID..." style="display:none;font-family:inherit">
            <button class="btn-action secondary" style="font-size:10px;padding:4px 8px" onclick="addProviderModel('${esc(name)}')">+</button>
          </div>
        </div>
      </div>
      <div class="provider-actions">
        <button class="btn-action primary" style="font-size:11px;padding:5px 12px" onclick="saveProvider('${esc(name)}')">Save</button>
        <div style="flex:1"></div>
        <button class="btn-icon danger" onclick="deleteProvider('${esc(name)}')" title="Delete provider">&#x1F5D1;</button>
      </div>
    </div>`;
  }).join('');
}

function toggleKeyVis(name) {
  const el = document.getElementById('key-' + name);
  el.type = el.type === 'password' ? 'text' : 'password';
}

function toggleNewKeyVis() {
  const el = document.getElementById('new-provider-key');
  el.type = el.type === 'password' ? 'text' : 'password';
}

async function saveProvider(name) {
  const keyEl = document.getElementById('key-' + name);
  const urlEl = document.getElementById('url-' + name);
  const payload = {};

  if (keyEl) payload.apiKey = keyEl.value;
  if (urlEl) payload.baseUrl = urlEl.value;

  try {
    const r = await fetch('/api/providers/' + encodeURIComponent(name) + '/update', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const d = await r.json();
    if (d.ok) {
      showToast(name + ' updated', 'success');
      fetchProviders();
      fetchAvailableModels();
    } else throw new Error(d.error);
  } catch(e) { showToast('Failed: ' + e.message, 'error'); }
}

async function addProvider() {
  const name = document.getElementById('new-provider-name').value.trim();
  const apiKey = document.getElementById('new-provider-key').value.trim();
  const baseUrl = document.getElementById('new-provider-url').value.trim();
  const modelsStr = document.getElementById('new-provider-models').value.trim();

  if (!name) { showToast('Provider name required', 'error'); return; }

  const models = modelsStr ? modelsStr.split(',').map(m => m.trim()).filter(Boolean) : [];

  try {
    const r = await fetch('/api/providers', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ name, apiKey, baseUrl, models })
    });
    const d = await r.json();
    if (d.ok) {
      showToast(name + ' added', 'success');
      document.getElementById('new-provider-name').value = '';
      document.getElementById('new-provider-key').value = '';
      document.getElementById('new-provider-url').value = '';
      document.getElementById('new-provider-models').value = '';
      fetchProviders();
      fetchAvailableModels();
    } else throw new Error(d.error);
  } catch(e) { showToast('Failed: ' + e.message, 'error'); }
}

async function deleteProvider(name) {
  if (!confirm('Delete provider "' + name + '"?')) return;
  try {
    const r = await fetch('/api/providers/' + encodeURIComponent(name) + '/delete', { method: 'POST' });
    const d = await r.json();
    if (d.ok) {
      showToast(name + ' deleted', 'info');
      fetchProviders();
      fetchAvailableModels();
    } else throw new Error(d.error);
  } catch(e) { showToast('Failed: ' + e.message, 'error'); }
}

async function addProviderModel(name) {
  const select = document.getElementById('add-model-' + name);
  const customInput = document.getElementById('add-model-custom-' + name);
  const model = select.value === '__custom__' ? customInput.value.trim() : select.value.trim();
  if (!model || !providersData || !providersData[name]) return;

  const models = [...(providersData[name].models || []), model];
  try {
    const r = await fetch('/api/providers/' + encodeURIComponent(name) + '/update', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ models })
    });
    const d = await r.json();
    if (d.ok) {
      select.value = '';
      customInput.value = '';
      customInput.style.display = 'none';
      showToast('Model added', 'success');
      fetchProviders();
      fetchAvailableModels();
    } else throw new Error(d.error);
  } catch(e) { showToast('Failed: ' + e.message, 'error'); }
}

async function removeProviderModel(name, model) {
  if (!providersData || !providersData[name]) return;
  const models = (providersData[name].models || []).filter(m => m !== model);
  try {
    const r = await fetch('/api/providers/' + encodeURIComponent(name) + '/update', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ models })
    });
    const d = await r.json();
    if (d.ok) {
      showToast('Model removed', 'info');
      fetchProviders();
      fetchAvailableModels();
    } else throw new Error(d.error);
  } catch(e) { showToast('Failed: ' + e.message, 'error'); }
}

function renderSettingsPanel() {
  if (!settingsData) return;
  const s = settingsData;

  // Gateway status
  fetchStatus();

  // Primary model dropdown
  const pmSel = document.getElementById('settings-primary-model');
  pmSel.innerHTML = availableModels.map(m =>
    `<option value="${esc(m)}" ${m===s.defaults.primary?'selected':''}>${esc(m)}</option>`
  ).join('');

  // Compaction
  document.getElementById('settings-compaction').value = s.defaults.compaction || 'safeguard';

  // Fallbacks
  renderFallbacks(s.defaults.fallbacks || []);

  // Add fallback dropdown
  const afSel = document.getElementById('add-fallback-select');
  afSel.innerHTML = availableModels.map(m =>
    `<option value="${esc(m)}">${esc(m)}</option>`
  ).join('');

  // Channels
  renderSettingsChannels(s.channels || {});
}

function renderFallbacks(fallbacks) {
  const el = document.getElementById('fallback-list');
  if (!fallbacks.length) { el.innerHTML = '<div style="color:var(--text-tertiary);font-size:11px;padding:4px 0">No fallbacks configured</div>'; return; }
  el.innerHTML = fallbacks.map((m, i) => `
    <div class="fallback-item">
      <span class="fb-order">${i+1}</span>
      <span class="fb-name">${esc(m)}</span>
      <button class="fb-move" onclick="moveFallback(${i},-1)" ${i===0?'disabled':''}>&uarr;</button>
      <button class="fb-move" onclick="moveFallback(${i},1)" ${i===fallbacks.length-1?'disabled':''}>&darr;</button>
      <button class="fb-remove" onclick="removeFallback(${i})">&times;</button>
    </div>
  `).join('');
}

async function saveDefaultModel() {
  const model = document.getElementById('settings-primary-model').value;
  const status = document.getElementById('default-model-status');
  status.textContent = 'Saving...'; status.style.color = 'var(--text-tertiary)';
  try {
    const r = await fetch('/api/defaults/model', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({primary: model})
    });
    const d = await r.json();
    if (d.ok) { status.textContent = 'Saved'; status.style.color = 'var(--green)'; showToast('Default model updated'); }
    else throw new Error(d.error);
  } catch(e) { status.textContent = 'Error: '+e.message; status.style.color = 'var(--red)'; }
  setTimeout(() => { status.textContent = ''; }, 3000);
}

async function saveFallbacks(fallbacks) {
  try {
    const r = await fetch('/api/defaults/model', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({fallbacks})
    });
    const d = await r.json();
    if (d.ok) {
      if (settingsData) settingsData.defaults.fallbacks = d.fallbacks;
      renderFallbacks(d.fallbacks);
      showToast('Fallback chain updated');
    }
  } catch(e) { showToast('Failed to save fallbacks', 'error'); }
}

function addFallback() {
  const sel = document.getElementById('add-fallback-select');
  const model = sel.value;
  if (!model || !settingsData) return;
  const fb = [...(settingsData.defaults.fallbacks || []), model];
  saveFallbacks(fb);
}

function removeFallback(idx) {
  if (!settingsData) return;
  const fb = [...(settingsData.defaults.fallbacks || [])];
  fb.splice(idx, 1);
  saveFallbacks(fb);
}

function moveFallback(idx, dir) {
  if (!settingsData) return;
  const fb = [...(settingsData.defaults.fallbacks || [])];
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= fb.length) return;
  [fb[idx], fb[newIdx]] = [fb[newIdx], fb[idx]];
  saveFallbacks(fb);
}

async function saveCompaction() {
  const mode = document.getElementById('settings-compaction').value;
  const status = document.getElementById('compaction-status');
  status.textContent = 'Saving...'; status.style.color = 'var(--text-tertiary)';
  try {
    const r = await fetch('/api/defaults/compaction', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({mode})
    });
    const d = await r.json();
    if (d.ok) { status.textContent = 'Saved'; status.style.color = 'var(--green)'; showToast('Compaction mode: '+d.mode); }
    else throw new Error(d.error);
  } catch(e) { status.textContent = 'Error: '+e.message; status.style.color = 'var(--red)'; }
  setTimeout(() => { status.textContent = ''; }, 3000);
}

function renderSettingsChannels(channels) {
  const el = document.getElementById('settings-channels');
  const names = Object.keys(channels);
  if (!names.length) { el.innerHTML = '<div style="color:var(--text-tertiary);font-size:11px">No channels configured</div>'; return; }

  el.innerHTML = names.map(name => {
    const ch = channels[name];
    return `
    <div class="channel-card">
      <div class="cc-header">
        <div class="cc-dot ${ch.enabled?'enabled':'disabled'}"></div>
        <span class="cc-name">${esc(name)}</span>
        <span class="cc-bot">${esc(ch.botName)}</span>
        <label class="toggle-switch">
          <input type="checkbox" ${ch.enabled?'checked':''} onchange="toggleChannel('${esc(name)}')">
          <div class="toggle-track"></div>
          <div class="toggle-knob"></div>
        </label>
      </div>
      <div class="cc-policies">
        <div class="cc-policy-row">
          <span class="cc-p-label">DM</span>
          <select class="cc-policy-select" onchange="saveChannelSetting('${esc(name)}','dmPolicy',this.value)">
            <option value="open" ${ch.dmPolicy==='open'?'selected':''}>Open</option>
            <option value="allowlist" ${ch.dmPolicy==='allowlist'?'selected':''}>Allowlist</option>
            <option value="closed" ${ch.dmPolicy==='closed'?'selected':''}>Closed</option>
          </select>
        </div>
        <div class="cc-policy-row">
          <span class="cc-p-label">Group</span>
          <select class="cc-policy-select" onchange="saveChannelSetting('${esc(name)}','groupPolicy',this.value)">
            <option value="open" ${ch.groupPolicy==='open'?'selected':''}>Open</option>
            <option value="allowlist" ${ch.groupPolicy==='allowlist'?'selected':''}>Allowlist</option>
            <option value="closed" ${ch.groupPolicy==='closed'?'selected':''}>Closed</option>
          </select>
        </div>
        <div class="cc-policy-row">
          <span class="cc-p-label">Stream</span>
          <select class="cc-policy-select" onchange="saveChannelSetting('${esc(name)}','streamMode',this.value)">
            <option value="partial" ${ch.streamMode==='partial'?'selected':''}>Partial</option>
            <option value="full" ${ch.streamMode==='full'?'selected':''}>Full</option>
            <option value="off" ${ch.streamMode==='off'?'selected':''}>Off</option>
          </select>
        </div>
      </div>
    </div>`;
  }).join('');
}

async function toggleChannel(name) {
  try {
    const r = await fetch('/api/channel/'+name+'/toggle', {method:'POST'});
    const d = await r.json();
    if (d.ok) {
      showToast(name + ' ' + (d.enabled ? 'enabled' : 'disabled'));
      fetchSettings();
      fetchSys();
    }
  } catch(e) { showToast('Failed to toggle channel', 'error'); }
}

async function saveChannelSetting(name, key, value) {
  try {
    const body = {}; body[key] = value;
    const r = await fetch('/api/channel/'+name+'/settings', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const d = await r.json();
    if (d.ok) showToast(name + ' ' + key + ' updated');
  } catch(e) { showToast('Failed to save setting', 'error'); }
}

/* Channels top stat bar — updated from /api/channels */
function renderChannelsStats(ch) {
  const running = ch.filter(c=>c.running).length;
  document.getElementById('fs-channels').textContent = running;
  document.getElementById('fs-ch-detail').textContent = `/ ${ch.length} running`;
  document.getElementById('fs-ch-bar').style.width = (ch.length ? running/ch.length*100 : 0) + '%';
}

function renderSessions(se) {
  const el=document.getElementById('se-info');
  if(!se.length){el.innerHTML='<div style="color:var(--text-tertiary);font-size:11px">No sessions</div>';return;}
  el.innerHTML=se.slice(0,10).map(s=>`<div class="ch-row"><div class="ch-dot" style="background:${PALETTES[s.agent]?PALETTES[s.agent].body:(isDarkMode()?'#48484a':'#c7c7cc')}"></div><span class="ch-name">${s.agent}</span><span class="ch-detail">${s.age||'--'}</span></div>`).join('');
}

function addLog(entry) {
  const c=document.getElementById('log-wrap'), d=document.createElement('div');
  d.className='log-line';
  const t=entry.time?new Date(entry.time).toTimeString().slice(0,8):'';
  d.innerHTML=`<span class="log-t">${t}</span><span class="log-l ${entry.level||'INFO'}">${(entry.level||'INFO').slice(0,4)}</span><span class="log-m">${esc((entry.message||'').substring(0,150))}</span>`;
  c.appendChild(d); if(c.children.length>150)c.firstChild.remove(); c.scrollTop=c.scrollHeight;
}

/* ── MD BACKUP ── */
let backupData = null;

async function fetchBackupStatus() {
  try {
    backupData = await (await fetch('/api/md-backup/status')).json();
    renderBackupPanel();
  } catch(e) {}
}

function renderBackupPanel() {
  if (!backupData) return;
  const pathEl = document.getElementById('backup-path');
  const displayEl = document.getElementById('backup-path-display');
  const enabledEl = document.getElementById('backup-enabled');
  const intervalEl = document.getElementById('backup-interval');
  const lastEl = document.getElementById('backup-last-info');

  if (pathEl) pathEl.value = backupData.path || '';
  if (displayEl) {
    const p = backupData.path || '';
    displayEl.textContent = p || 'Not set';
    displayEl.title = p;
  }
  if (enabledEl) enabledEl.checked = backupData.enabled || false;
  if (intervalEl) intervalEl.value = String(backupData.interval_minutes || 60);

  if (lastEl) {
    if (backupData.last_backup) {
      const r = backupData.last_result || {};
      lastEl.textContent = 'Last: ' + backupData.last_backup + ' \u2014 ' + (r.files_copied||0) + ' files, ' + (r.agents||[]).length + ' agents';
    } else {
      lastEl.textContent = 'No backup yet';
    }
  }
}

async function saveBackupSettings() {
  const path = document.getElementById('backup-path').value.trim();
  const enabled = document.getElementById('backup-enabled').checked;
  const interval = parseInt(document.getElementById('backup-interval').value);
  const st = document.getElementById('backup-status');
  try {
    const r = await fetch('/api/md-backup/settings', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({path, enabled, interval_minutes: interval})
    });
    const d = await r.json();
    if (!r.ok) { showToast(d.error || 'Failed to save', 'error'); if(st) st.textContent=d.error||''; return; }
    showToast('Backup settings saved');
    if(st) st.textContent='';
    fetchBackupStatus();
  } catch(e) { showToast('Failed to save backup settings', 'error'); }
}

async function triggerBackupExport() {
  const btn = document.getElementById('btn-backup-export');
  const st = document.getElementById('backup-status');
  const path = document.getElementById('backup-path').value.trim();
  if (path && (!backupData || backupData.path !== path)) {
    await saveBackupSettings();
  }
  btn.disabled = true; btn.textContent = 'Exporting...';
  try {
    const r = await fetch('/api/md-backup/export', {method:'POST'});
    const d = await r.json();
    if (!r.ok) { showToast(d.error || 'Export failed', 'error'); if(st) st.textContent=d.error||''; return; }
    showToast('Backup complete: ' + d.files_copied + ' files from ' + d.agents.length + ' agents');
    if(st) st.textContent='';
    fetchBackupStatus();
  } catch(e) { showToast('Export failed', 'error'); }
  finally { btn.disabled = false; btn.textContent = 'Export Now'; }
}

/* ── DIRECTORY BROWSER ── */
let dirBrowserPath = '/';

function openDirBrowser() {
  const current = document.getElementById('backup-path').value.trim();
  dirBrowserPath = current || '/';
  document.getElementById('dir-overlay').classList.add('show');
  document.getElementById('dir-new-name').value = '';
  fetchDirs(dirBrowserPath);
}

function closeDirBrowser() {
  document.getElementById('dir-overlay').classList.remove('show');
}

async function fetchDirs(path) {
  const errEl = document.getElementById('dir-error');
  const listEl = document.getElementById('dir-list');
  const pathEl = document.getElementById('dir-current-path');
  errEl.style.display = 'none';
  listEl.innerHTML = '<div class="dir-modal-empty">Loading...</div>';
  try {
    const r = await fetch('/api/browse-dirs?path=' + encodeURIComponent(path));
    const d = await r.json();
    if (!r.ok) {
      errEl.textContent = d.error || 'Failed to browse';
      errEl.style.display = '';
      listEl.innerHTML = '<div class="dir-modal-empty">Cannot access this directory</div>';
      return;
    }
    dirBrowserPath = d.current;
    pathEl.textContent = d.current;
    renderDirList(d);
  } catch(e) {
    errEl.textContent = 'Network error';
    errEl.style.display = '';
    listEl.innerHTML = '';
  }
}

function renderDirList(data) {
  const listEl = document.getElementById('dir-list');
  listEl.innerHTML = '';
  if (data.parent !== null && data.parent !== undefined) {
    const item = document.createElement('button');
    item.className = 'dir-modal-item parent-dir';
    item.innerHTML = '<span class="dir-icon">\u2B06</span> ..';
    item.onclick = () => fetchDirs(data.parent);
    listEl.appendChild(item);
  }
  if (data.dirs.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'dir-modal-empty';
    empty.textContent = 'No subdirectories';
    listEl.appendChild(empty);
    return;
  }
  for (const name of data.dirs) {
    const item = document.createElement('button');
    item.className = 'dir-modal-item';
    item.innerHTML = '<span class="dir-icon">\uD83D\uDCC1</span> ' + esc(name);
    const fullPath = data.current === '/' ? '/' + name : data.current + '/' + name;
    item.onclick = () => fetchDirs(fullPath);
    listEl.appendChild(item);
  }
}

function selectDir() {
  const pathInput = document.getElementById('backup-path');
  const displayEl = document.getElementById('backup-path-display');
  pathInput.value = dirBrowserPath;
  if (displayEl) {
    displayEl.textContent = dirBrowserPath;
    displayEl.title = dirBrowserPath;
  }
  closeDirBrowser();
  saveBackupSettings();
}

async function createBackupDir() {
  const nameInput = document.getElementById('dir-new-name');
  const name = nameInput.value.trim();
  if (!name) return;
  const errEl = document.getElementById('dir-error');
  const fullPath = dirBrowserPath === '/' ? '/' + name : dirBrowserPath + '/' + name;
  try {
    const r = await fetch('/api/mkdir', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({path: fullPath})
    });
    const d = await r.json();
    if (!r.ok) {
      errEl.textContent = d.error || 'Failed to create folder';
      errEl.style.display = '';
      return;
    }
    nameInput.value = '';
    fetchDirs(dirBrowserPath);
  } catch(e) {
    errEl.textContent = 'Network error';
    errEl.style.display = '';
  }
}

/* ── VIEW SWITCHING ── */
let currentView = 'office';

let _viewSwitching = false;
function switchView(name) {
  if (name === currentView || _viewSwitching) return;
  _viewSwitching = true;
  const oldView = document.getElementById('view-' + currentView);
  const newView = document.getElementById('view-' + name);
  currentView = name;
  document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('nav-' + name).classList.add('active');

  // Exit animation on old view
  if (oldView) {
    oldView.classList.remove('active');
    oldView.classList.add('view-exit');
  }

  // Enter animation on new view after exit completes
  setTimeout(() => {
    document.querySelectorAll('.view-container').forEach(el => {
      el.classList.remove('active');
      el.classList.remove('view-exit');
    });
    newView.classList.add('active');
    _viewSwitching = false;
  }, 150);

  if (name === 'tasks') { loadTasks(); loadTaskStats(); }
  if (name === 'calendar') renderCalendar();
}

/* ── TASK MANAGER ── */
let allTasks = [];
let taskFilterAgent = '';
let taskFilterStatus = '';
let taskStats = {};
let completedCollapsed = true;

function renderTaskFilters() {
  const agents = Object.values(agentMap);
  let html = '<button class="filter-pill ' + (!taskFilterAgent ? 'active' : '') + '" onclick="setTaskFilterAgent(\'\')">All Agents</button>';
  agents.forEach(a => {
    html += `<button class="filter-pill ${taskFilterAgent === a.id ? 'active' : ''}" onclick="setTaskFilterAgent('${esc(a.id)}')">${esc(a.name)}</button>`;
  });
  html += '<div class="filter-sep"></div>';
  html += '<button class="filter-pill ' + (!taskFilterStatus ? 'active' : '') + '" onclick="setTaskFilterStatus(\'\')">All</button>';
  ['pending', 'in_progress', 'completed'].forEach(s => {
    const label = s === 'in_progress' ? 'In Progress' : s.charAt(0).toUpperCase() + s.slice(1);
    html += `<button class="filter-pill ${taskFilterStatus === s ? 'active' : ''}" onclick="setTaskFilterStatus('${s}')">${label}</button>`;
  });
  html += '<div style="flex:1"></div><button class="btn-action primary" onclick="openTaskModal()">+ New Task</button>';
  document.getElementById('task-filters').innerHTML = html;
}

function setTaskFilterAgent(a) { taskFilterAgent = a; loadTasks(); }
function setTaskFilterStatus(s) { taskFilterStatus = s; loadTasks(); }

async function loadTasks() {
  renderTaskFilters();
  let url = '/api/tasks?';
  if (taskFilterAgent) url += 'agent=' + encodeURIComponent(taskFilterAgent) + '&';
  if (taskFilterStatus) url += 'status=' + encodeURIComponent(taskFilterStatus) + '&';
  try {
    allTasks = await (await fetch(url)).json();
    renderTasks();
  } catch (e) {}
}

async function loadTaskStats() {
  try {
    taskStats = await (await fetch('/api/tasks/stats')).json();
    renderTaskStatsBar();
  } catch (e) {}
}

function renderTasks() {
  const pending = allTasks.filter(t => t.status === 'pending');
  const inProgress = allTasks.filter(t => t.status === 'in_progress');
  const completed = allTasks.filter(t => t.status === 'completed');
  let html = '';

  if (pending.length || !taskFilterStatus) {
    html += taskSectionHtml('Pending', pending.length, false);
    html += pending.map(taskCardHtml).join('');
  }
  if (inProgress.length || !taskFilterStatus) {
    html += taskSectionHtml('In Progress', inProgress.length, false);
    html += inProgress.map(taskCardHtml).join('');
  }
  if (completed.length || !taskFilterStatus) {
    html += taskSectionHtml('Completed', completed.length, true);
    if (!completedCollapsed) html += completed.map(taskCardHtml).join('');
  }

  if (!allTasks.length) {
    html = '<div style="text-align:center;padding:60px 20px;color:var(--text-tertiary)"><div style="font-size:32px;margin-bottom:12px">&#x2705;</div><div style="font-size:13px">No tasks yet. Create one to get started.</div></div>';
  }
  document.getElementById('task-content').innerHTML = html;
}

function taskSectionHtml(label, count, collapsible) {
  const iconClass = collapsible && completedCollapsed ? 'collapsed' : '';
  const onclick = collapsible ? 'onclick="toggleCompleted()"' : '';
  return `<div class="task-section-hdr" ${onclick}><span class="tsh-icon ${iconClass}">&#x25BC;</span><span class="tsh-label">${label}</span><span class="tsh-count">${count}</span></div>`;
}

function toggleCompleted() { completedCollapsed = !completedCollapsed; renderTasks(); }

function taskCardHtml(t) {
  const a = agentMap[t.assignedTo];
  const agentName = a ? a.name : (t.assignedTo || 'Unassigned');
  let dueHtml = '';
  if (t.dueDate) {
    const isOverdue = new Date(t.dueDate) < new Date() && t.status !== 'completed';
    dueHtml = `<span class="due-badge ${isOverdue ? 'overdue' : ''}">${t.dueDate}</span>`;
  }
  let actions = '';
  if (t.status === 'pending') {
    actions += `<button class="task-action-btn" onclick="updateTaskStatus('${t.id}','in_progress')">&#x25B6; Start</button>`;
    actions += `<button class="task-action-btn complete" onclick="updateTaskStatus('${t.id}','completed')">&#x2713;</button>`;
  } else if (t.status === 'in_progress') {
    actions += `<button class="task-action-btn complete" onclick="updateTaskStatus('${t.id}','completed')">&#x2713; Done</button>`;
  } else {
    actions += `<button class="task-action-btn" onclick="updateTaskStatus('${t.id}','pending')">&#x21A9; Reopen</button>`;
  }
  actions += `<button class="task-action-btn delete" onclick="deleteTask('${t.id}')">&#x2715;</button>`;

  return `<div class="task-card">
    <div class="task-card-top">
      <div class="task-card-title">${esc(t.title)}</div>
      <div class="task-card-actions">${actions}</div>
    </div>
    ${t.description ? `<div class="task-card-desc">${esc(t.description)}</div>` : ''}
    <div class="task-card-meta">
      <span class="priority-badge ${t.priority}">${t.priority}</span>
      <span class="agent-badge-sm">${esc(agentName)}</span>
      ${dueHtml}
    </div>
  </div>`;
}

function renderTaskStatsBar() {
  const s = taskStats;
  document.getElementById('task-stats-bar').innerHTML = `
    <div class="task-stat-item"><span class="task-stat-num">${s.total || 0}</span> Total</div>
    <div class="task-stat-item"><span class="task-stat-num" style="color:var(--orange)">${s.pending || 0}</span> Pending</div>
    <div class="task-stat-item"><span class="task-stat-num" style="color:var(--blue)">${s.in_progress || 0}</span> In Progress</div>
    <div class="task-stat-item"><span class="task-stat-num" style="color:var(--green)">${s.completed || 0}</span> Completed</div>`;
}

function openTaskModal() {
  const sel = document.getElementById('tm-agent');
  sel.innerHTML = '<option value="">Unassigned</option>';
  Object.values(agentMap).forEach(a => {
    sel.innerHTML += `<option value="${esc(a.id)}">${esc(a.name)}</option>`;
  });
  document.getElementById('tm-title').value = '';
  document.getElementById('tm-desc').value = '';
  document.getElementById('tm-priority').value = 'medium';
  document.getElementById('tm-due').value = '';
  document.getElementById('task-modal').classList.add('show');
}

function closeTaskModal() { document.getElementById('task-modal').classList.remove('show'); }

async function createTask() {
  const title = document.getElementById('tm-title').value.trim();
  if (!title) return;
  try {
    await fetch('/api/tasks', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        title,
        description: document.getElementById('tm-desc').value.trim(),
        assignedTo: document.getElementById('tm-agent').value,
        priority: document.getElementById('tm-priority').value,
        dueDate: document.getElementById('tm-due').value || null,
      })
    });
    closeTaskModal();
    loadTasks(); loadTaskStats();
    showToast('Task created', 'success');
  } catch (e) { showToast('Failed to create task', 'error'); }
}

async function updateTaskStatus(id, status) {
  try {
    await fetch(`/api/tasks/${id}/update`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ status })
    });
    loadTasks(); loadTaskStats();
  } catch (e) { showToast('Failed to update task', 'error'); }
}

async function deleteTask(id) {
  try {
    await fetch(`/api/tasks/${id}/delete`, { method: 'POST' });
    loadTasks(); loadTaskStats();
    showToast('Task deleted', 'info');
  } catch (e) { showToast('Failed to delete task', 'error'); }
}

/* ── CALENDAR ── */
let calYear, calMonth;
let calEvents = [];

(function initCalDate() {
  const now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth();
})();

const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAY_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

function calNavMonth(delta) {
  calMonth += delta;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  if (calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar();
}

async function renderCalendar() {
  const monthStr = `${calYear}-${String(calMonth + 1).padStart(2, '0')}`;
  document.getElementById('cal-month-label').textContent = `${MONTH_NAMES[calMonth]} ${calYear}`;

  try {
    calEvents = await (await fetch(`/api/calendar?month=${monthStr}`)).json();
  } catch (e) { calEvents = []; }

  const grid = document.getElementById('cal-grid');
  let html = DAY_NAMES.map(d => `<div class="cal-day-hdr">${d}</div>`).join('');

  const firstDay = new Date(calYear, calMonth, 1);
  let startDow = firstDay.getDay() - 1; // Mon=0
  if (startDow < 0) startDow = 6;

  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const daysInPrev = new Date(calYear, calMonth, 0).getDate();

  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

  // Previous month days
  for (let i = startDow - 1; i >= 0; i--) {
    const d = daysInPrev - i;
    html += `<div class="cal-day other-month"><div class="cal-day-num">${d}</div></div>`;
  }

  // Current month days
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    const dayEvents = calEvents.filter(e => e.date === dateStr);
    const evHtml = dayEvents.map(e =>
      `<div class="cal-event-pill ${e.type}" title="${esc(e.title)}${e.time ? ' @ ' + e.time : ''}" onclick="event.stopPropagation();deleteCalEvent('${e.id}')">${esc(e.title)}</div>`
    ).join('');
    html += `<div class="cal-day${isToday ? ' today' : ''}"><div class="cal-day-num">${d}</div>${evHtml}</div>`;
  }

  // Next month padding
  const totalCells = startDow + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for (let d = 1; d <= remaining; d++) {
    html += `<div class="cal-day other-month"><div class="cal-day-num">${d}</div></div>`;
  }

  grid.innerHTML = html;
}

function openCalendarModal() {
  const sel = document.getElementById('cm-agent');
  sel.innerHTML = '<option value="all">All Agents</option>';
  Object.values(agentMap).forEach(a => {
    sel.innerHTML += `<option value="${esc(a.id)}">${esc(a.name)}</option>`;
  });
  document.getElementById('cm-title').value = '';
  document.getElementById('cm-desc').value = '';
  const maxDay = new Date(calYear, calMonth + 1, 0).getDate();
  const defaultDay = Math.min(new Date().getDate(), maxDay);
  document.getElementById('cm-date').value = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(defaultDay).padStart(2, '0')}`;
  document.getElementById('cm-time').value = '09:00';
  document.getElementById('cm-type').value = 'reminder';
  document.getElementById('cal-modal').classList.add('show');
}

function closeCalendarModal() { document.getElementById('cal-modal').classList.remove('show'); }

async function createCalEvent() {
  const title = document.getElementById('cm-title').value.trim();
  const date = document.getElementById('cm-date').value;
  if (!title || !date) return;
  try {
    await fetch('/api/calendar', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        title,
        description: document.getElementById('cm-desc').value.trim(),
        date,
        time: document.getElementById('cm-time').value,
        agentId: document.getElementById('cm-agent').value,
        type: document.getElementById('cm-type').value,
      })
    });
    closeCalendarModal();
    renderCalendar();
    showToast('Event created', 'success');
  } catch (e) { showToast('Failed to create event', 'error'); }
}

async function deleteCalEvent(id) {
  try {
    await fetch(`/api/calendar/${id}/delete`, { method: 'POST' });
    renderCalendar();
    showToast('Event deleted', 'info');
  } catch (e) { showToast('Failed to delete event', 'error'); }
}

/* ── AGENT PROFILE ── */
let profileData = {};

async function loadProfile(agentId) {
  const body = document.getElementById('dp-body');
  body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-tertiary);font-size:12px">Loading profile...</div>';
  try {
    profileData = await (await fetch(`/api/agent/${agentId}/profile`)).json();
    renderProfile(agentId);
  } catch (e) {
    body.innerHTML = '<div style="color:var(--red);font-size:12px;padding:20px;text-align:center">Failed to load profile.</div>';
  }
}

function renderProfile(agentId) {
  const body = document.getElementById('dp-body');
  const d = detailCache || {};
  const a = agentMap[agentId] || {};
  const files = ['IDENTITY.md', 'SOUL.md', 'MEMORY.md', 'TOOLS.md'];
  let html = '';

  files.forEach(fname => {
    const content = profileData[fname] || '';
    const escapedContent = esc(content);
    html += `<div class="profile-section">
      <div class="profile-section-hdr">
        <span class="profile-section-title">${fname}</span>
        <button class="profile-save-btn" id="prof-save-${fname.replace('.','')}" onclick="saveProfile('${agentId}','${fname}')">Save</button>
      </div>
      <textarea class="profile-textarea" id="prof-${fname.replace('.','')}">${escapedContent}</textarea>
    </div>`;
  });

  html += `<div class="profile-info">
    <div class="profile-info-row"><span>Model</span><span class="v">${esc(a.model || d.model || 'unknown')}</span></div>
    <div class="profile-info-row"><span>Sessions</span><span class="v">${d.sessionCount || 0}</span></div>
    <div class="profile-info-row"><span>Input Tokens</span><span class="v">${((d.tokens||{}).input||0).toLocaleString()}</span></div>
    <div class="profile-info-row"><span>Output Tokens</span><span class="v">${((d.tokens||{}).output||0).toLocaleString()}</span></div>
  </div>`;

  body.innerHTML = html;
}

async function saveProfile(agentId, filename) {
  const textareaId = 'prof-' + filename.replace('.', '');
  const btnId = 'prof-save-' + filename.replace('.', '');
  const content = document.getElementById(textareaId).value;
  const btn = document.getElementById(btnId);
  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    await fetch(`/api/agent/${agentId}/profile`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ filename, content })
    });
    btn.textContent = 'Saved!'; btn.classList.add('saved');
    setTimeout(() => { btn.textContent = 'Save'; btn.classList.remove('saved'); btn.disabled = false; }, 1500);
  } catch (e) {
    btn.textContent = 'Error'; btn.disabled = false;
    showToast('Failed to save ' + filename, 'error');
  }
}

/* ── ANIMATED COUNTER ── */
function animateCounter(el, target, duration=600) {
  const start = parseInt(el.textContent) || 0;
  if (start === target) return;
  el.classList.add('counting');
  const startTime = performance.now();
  function tick(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(start + (target - start) * eased);
    if (progress < 1) requestAnimationFrame(tick);
    else { el.textContent = target; el.classList.remove('counting'); }
  }
  requestAnimationFrame(tick);
}

function pulseStatCard(el) {
  el.classList.remove('pulse');
  void el.offsetWidth;
  el.classList.add('pulse');
}

/* ── HERO PARTICLES ── */
function initHeroParticles() {
  const canvas = document.getElementById('hero-particles');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let w, h, particles = [];

  function resize() {
    const rect = canvas.parentElement.getBoundingClientRect();
    w = canvas.width = rect.width;
    h = canvas.height = rect.height;
  }
  resize();
  window.addEventListener('resize', resize);

  for (let i = 0; i < 30; i++) {
    particles.push({
      x: Math.random() * w, y: Math.random() * h,
      vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.3,
      r: Math.random() * 2.5 + 1, a: Math.random() * 0.4 + 0.1,
    });
  }

  function draw() {
    ctx.clearRect(0, 0, w, h);
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy;
      if (p.x < 0) p.x = w; if (p.x > w) p.x = 0;
      if (p.y < 0) p.y = h; if (p.y > h) p.y = 0;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,255,255,${p.a})`;
      ctx.fill();
    });
    // Draw connection lines
    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 100) {
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.strokeStyle = `rgba(255,255,255,${0.12 * (1 - dist/100)})`;
          ctx.lineWidth = 0.5;
          ctx.stroke();
        }
      }
    }
    requestAnimationFrame(draw);
  }
  draw();
}

/* ── HERO STATUS UPDATE ── */
function updateHero(agents) {
  const active = agents.filter(a => a.status === 'busy' || a.status === 'idle').length;
  const total = agents.length;
  const titleEl = document.getElementById('hero-title');
  const subEl = document.getElementById('hero-sub');
  const now = new Date();
  const hour = now.getHours();
  let greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
  if (titleEl) titleEl.textContent = `${greeting}, Commander`;
  if (subEl) subEl.textContent = `${active}/${total} agents active \u2022 ${now.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'})}`;
}

/* ── ACTIVITY TICKER ── */
function updateTicker(agents) {
  const track = document.getElementById('ticker-track');
  if (!track) return;
  const items = agents.map(a => {
    const task = a.currentTask ? a.currentTask.substring(0, 60) : 'Idle';
    return `<span class="ticker-item"><span class="ticker-dot ${a.status||'offline'}"></span><span class="ticker-name">${esc(a.name)}</span>${esc(task)}</span><span class="ticker-sep">\u25C6</span>`;
  }).join('');
  // Duplicate for seamless loop
  track.innerHTML = items + items;
  const count = agents.length;
  track.style.setProperty('--ticker-duration', Math.max(count * 6, 20) + 's');
}

/* FETCH */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

async function fetchStatus() {
  try {
    const d=await(await fetch('/api/status')).json();
    const dot=document.getElementById('gw-dot'), badge=document.getElementById('gw-badge');
    dot.className=d.active?'on':'';
    badge.className=d.active?'':'offline-badge';
    document.getElementById('gw-lbl').textContent=d.active?'Online'+(d.uptime?' \u00B7 '+d.uptime.split(';')[0]:''):'Offline';
    document.getElementById('topbar-meta').textContent=`v${d.version||'?'}`+(d.memory?` \u00B7 ${d.memory}`:'')+(d.pid?` \u00B7 PID ${d.pid}`:'');
    document.getElementById('fs-gw-status').textContent=d.active?'Online':'Offline';
    document.getElementById('fs-gw-uptime').textContent=d.uptime?d.uptime.split(';')[0]:'';
    document.getElementById('fs-gw-bar').style.width=d.active?'100%':'0%';
    // Update settings panel gateway status
    const gwSt=document.getElementById('gw-service-status');
    if(gwSt) gwSt.textContent=d.active?'Running'+(d.pid?' (PID '+d.pid+')':'')+(d.memory?' \u00B7 '+d.memory:''):'Stopped';
  } catch(e){}
}

async function fetchAgents() {
  try {
    const agents=await(await fetch('/api/agents')).json();
    agents.forEach(a=>{a.status=calcStatus(a.lastActivity);agentMap[a.id]=a;});
    office.update(agents); renderSidebar(agents);
    if (selectedId&&curTab==='overview') renderDetail();
    // Animated updates
    updateHero(agents);
    updateTicker(agents);
    const activeCount = agents.filter(a=>a.status==='busy'||a.status==='idle').length;
    const totalSessions = agents.reduce((s,a)=>s+a.activeSessions,0);
    const fsActive = document.getElementById('fs-active');
    const fsSessions = document.getElementById('fs-sessions');
    const prevActive = parseInt(fsActive?.textContent) || 0;
    const prevSessions = parseInt(fsSessions?.textContent) || 0;
    if (fsActive) animateCounter(fsActive, activeCount);
    if (fsSessions) animateCounter(fsSessions, totalSessions);
    // Pulse only when values change
    if (prevActive !== activeCount || prevSessions !== totalSessions) {
      document.querySelectorAll('.fstat').forEach(el => pulseStatCard(el));
    }
  } catch(e){}
}

async function fetchSys() {
  try {
    const [ch,se]=await Promise.all([fetch('/api/channels').then(r=>r.json()),fetch('/api/sessions').then(r=>r.json())]);
    renderChannelsStats(ch); renderSessions(se);
  } catch(e){}
}

async function fetchLogs() { try{const logs=await(await fetch('/api/logs/recent')).json();logs.forEach(addLog);}catch(e){} }

function startSSE() {
  const es=new EventSource('/events');
  es.onmessage=e=>{try{addLog(JSON.parse(e.data));}catch(e){}};
  es.onerror=()=>setTimeout(startSSE,5000);
}

/* INIT */
const office=new OfficeMap(document.getElementById('office'));
document.getElementById('task-form').style.display='none';
initHeroParticles();

(async()=>{
  await fetchStatus(); await fetchAgents(); fetchSys(); fetchLogs(); startSSE();
  fetchAvailableModels();
  fetchAvailablePlatforms();
  document.getElementById('task-form').style.display=curTab==='task'?'block':'none';
})();
setInterval(fetchStatus,10000); setInterval(fetchAgents,10000); setInterval(fetchSys,30000);
</script>
</body>
</html>
